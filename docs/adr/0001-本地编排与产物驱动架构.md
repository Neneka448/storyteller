# ADR 0001：本地编排引擎 + 产物驱动的创作流程（Electron）

日期：2025-12-13

## 状态
提议（Proposed）

## 背景 / 产品理解
产品的核心不是“像 n8n 一样必须可视化连线”，而是：
- 用户通过 Chat 指导 AI：讲故事、提要求、指出要改哪里。
- 系统把创作拆成一系列“步骤（Step）”，每一步产生可见的“产物（Artifact）”。
- 用户能随时：查看每一步产物 → 决定继续/回退/改写 → 让 AI 根据反馈更新某些步骤 → 再继续往下。

换句话说：**产物可见 + 下一步清晰** 才是关键体验；编排形式（线性/图）是实现细节，可后置。

## 关键约束
- 运行时尽量都在用户客户端本地（Electron App 内）。
- 需要具备“像工作流引擎一样”的能力：步骤依赖、状态机、失败重试、可恢复、可追踪。
- 节点/步骤的 UI 必须可定制：可展示图/文本/表格/视频等富产物。
- 任务实际执行会调用外部 GPU 平台接口（HTTP/SDK），本地主要做调度与结果汇总。

## 决策
1) **不嵌入 n8n/Node-RED 的整套编辑器与运行时**，而是采用“本地最小编排引擎（Orchestrator）+ 可演进”的路线。
2) 渲染进程（UI）负责：
   - Chat 面板（消息、工具调用日志、重跑/回滚按钮）
   - 步骤列表/时间线（每一步状态 + 产物摘要）
   - 产物查看器（根据 Artifact 类型渲染：脚本/分镜/图片/视频）
3) 主进程（或独立 Node 子进程）负责：
   - 编排引擎：执行 DAG/线性步骤、重试、并发控制、超时
   - 调用外部 GPU 平台 API
   - 本地存储：项目/运行/产物/日志
   - 通过 IPC 向 UI 推送运行事件（event stream）

## 方案细化
### A. “步骤（Step）”模型（面向产品）
每个 Step 代表一个用户能理解的阶段，例如：
- 人物设定（产物：角色设定图 + 设定文本）
- 剧本生成（产物：脚本 Markdown/JSON）
- 分镜生成（产物：镜头列表表格 + 每镜提示词）
- 图生成（产物：每镜图片）
- 视频生成（产物：合成视频或镜头视频）

Step 最小字段建议：
- stepId / title / kind
- inputs（来自用户、来自上游产物引用）
- outputs（Artifact 引用列表）
- status：queued/running/succeeded/failed/canceled
- timestamps、error、retries

### B. 工作流表达（面向可演进）
MVP：线性 Pipeline（数组）即可。
- 优点：产品更好理解；实现最简单。
- 后续：升级为 DAG（steps + dependencies）以支持分支、并行。

### C. 本地“集成服务端”的实现方式
Electron 并不限制你在主进程运行 Node 能力（网络、文件 IO）。推荐优先级：
1. **IPC（Renderer ↔ Main）**：最简单、无需占端口、权限更少。
2. 若未来需要外部工具/插件接入：再加一个本地 HTTP Server（可选）。
3. 若步骤执行很重：用 child_process 拉起独立 Orchestrator 进程（避免主进程阻塞）。

### D. 产物（Artifact）驱动 UI
Artifact 统一类型与渲染协议：
- type：script/storyboard/image/video/log/json
- uri：file://… 或 app://…（本地路径建议由主进程管理并做安全校验）
- meta：生成参数、来源 stepId、provider、hash、尺寸/时长

渲染层按 type 做组件分发：
- script：Markdown 预览 + diff（后续）
- storyboard：表格/卡片
- image/video：缩略图 + 预览

## 替代方案（未选）
### 1) 直接嵌入 n8n
- 优点：成熟编排与大量 connector。
- 缺点：产品 UI 难以按“产物可见”深度定制；运行时与许可/部署复杂度更高；Electron 里嵌入整套服务端并不轻。

### 2) Node-RED
- 优点：开源许可更清晰，编辑器成熟。
- 缺点：同样很难做成“每节点=富产物展示”的产品体验；嵌入式运维复杂。

## 结果与影响
- 我们能快速得到一个产品可用的 MVP：Chat 驱动 + 可回溯步骤 + 可见产物。
- 代价：需要自己实现最小编排引擎与状态机。
- 演进路径清晰：线性 → DAG；内置节点 → 插件化；IPC → 可选本地 HTTP。

## 下一步（落地顺序）
1. 定义数据模型：Project / Pipeline / Step / Run / Artifact / Event
2. 做最小 UI：左侧 Steps 时间线 + 右侧 Artifact Viewer + Chat
3. 做最小 Orchestrator：顺序执行 + 失败重试 + 事件推送
4. 先接一个外部 provider：文本（脚本/分镜）→ 再接图 → 再接视频
