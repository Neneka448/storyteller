# ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„ AI Agent å·¥ä½œæµè®¾è®¡

## 1. æ ¸å¿ƒæ´å¯Ÿï¼šè®¾å®šå†™ä½œâ‰ˆä»£ç å†™ä½œ

### 1.1 å…³é”®ç±»æ¯”

**ç”¨æˆ·è§‚å¯Ÿ**ï¼š"è®¾å®šå†™ä½œå…¶å®å’Œä»£ç å†™ä½œä¸€æ ·ï¼Œå…³è”å’Œé€»è¾‘æ€§å¾ˆé‡è¦"

è¿™ä¸ªç±»æ¯”éå¸¸æ·±åˆ»ï¼š

| ç»´åº¦ | ä»£ç å†™ä½œ | è®¾å®šå†™ä½œ | å…±åŒç‚¹ |
|-----|---------|---------|--------|
| **ä¾èµ–å…³ç³»** | import/require | å¼•ç”¨å…¶ä»–è®¾å®š | æ–°å†…å®¹ä¾èµ–å·²æœ‰å†…å®¹ |
| **ä¸€è‡´æ€§** | ç±»å‹ç³»ç»Ÿ | ä¸–ç•Œè§‚è§„åˆ™ | å‰åä¸èƒ½çŸ›ç›¾ |
| **æ¨¡å—åŒ–** | å‡½æ•°/ç±» | è¯æ¡/èŠ‚ç‚¹ | å¯ç»„åˆã€å¯å¤ç”¨ |
| **é‡æ„** | æ”¹å˜æ¥å£ | ä¿®æ”¹è®¾å®š | éœ€è¦æ›´æ–°æ‰€æœ‰å¼•ç”¨ |
| **æµ‹è¯•** | å•å…ƒæµ‹è¯• | è®¾å®šéªŒè¯ | æ£€æŸ¥é€»è¾‘ä¸€è‡´æ€§ |
| **æ–‡æ¡£** | README/æ³¨é‡Š | ä¸–ç•Œè§‚åœ£ç» | å¸®åŠ©ç†è§£ä¸Šä¸‹æ–‡ |

### 1.2 é—®é¢˜é™ˆè¿°

**å½“å‰é—®é¢˜**ï¼š
- AI ä¸çŸ¥é“å·²æœ‰è®¾å®šï¼Œå®¹æ˜“"æ— ä¸­ç”Ÿæœ‰"
- åˆ›å»ºæŠ€èƒ½æ—¶ä¸å‚è€ƒèƒ½é‡ä½“ç³»ã€èµ„æºç³»ç»Ÿç­‰å·²æœ‰è¯æ¡
- ç¼ºå°‘"å…ˆç†è§£ä¸Šä¸‹æ–‡ï¼Œå†åˆ›ä½œ"çš„å·¥ä½œæµ

**ç›®æ ‡**ï¼š
- AI åƒå†™ä»£ç çš„ Agent ä¸€æ ·ï¼Œå…ˆ grep/search å·²æœ‰è®¾å®š
- ç†è§£ä¾èµ–å…³ç³»ï¼ˆå¦‚æŠ€èƒ½ä¾èµ–èƒ½é‡ä½“ç³»ï¼‰
- åŸºäºå·²æœ‰è®¾å®šæ‰©å†™ï¼Œä¿æŒä¸€è‡´æ€§

---

## 2. è®¾è®¡åŸåˆ™ï¼šRAG + ä¾èµ–å›¾ + å·¥å…·é“¾

### 2.1 æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æ„å›¾                                              â”‚
â”‚  "åˆ›å»ºä¸€ä¸ªé›·ç”µé­”æ³•æŠ€èƒ½"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: ä¸Šä¸‹æ–‡æ”¶é›†ï¼ˆContext Gatheringï¼‰              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. ç†è§£æ„å›¾ â†’ è¯†åˆ«ä¾èµ–ç±»å‹                       â”‚ â”‚
â”‚  â”‚    "æŠ€èƒ½" â†’ éœ€è¦ï¼šèƒ½é‡ä½“ç³»ã€èµ„æºã€æŠ€èƒ½æ ‘        â”‚ â”‚
â”‚  â”‚                                                  â”‚ â”‚
â”‚  â”‚ 2. æœç´¢å·²æœ‰è®¾å®š                                  â”‚ â”‚
â”‚  â”‚    - Vector Searchï¼šè¯­ä¹‰ç›¸ä¼¼çš„è¯æ¡              â”‚ â”‚
â”‚  â”‚    - Graph Searchï¼šä¾èµ–å›¾ä¸­çš„ç›¸å…³èŠ‚ç‚¹            â”‚ â”‚
â”‚  â”‚    - Grep Searchï¼šå…³é”®è¯ç²¾ç¡®åŒ¹é…                â”‚ â”‚
â”‚  â”‚                                                  â”‚ â”‚
â”‚  â”‚ 3. æ„å»ºä¸Šä¸‹æ–‡                                    â”‚ â”‚
â”‚  â”‚    - ç›¸å…³è¯æ¡å†…å®¹                                â”‚ â”‚
â”‚  â”‚    - ä¾èµ–å…³ç³»è¯´æ˜                                â”‚ â”‚
â”‚  â”‚    - çº¦æŸè§„åˆ™                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 2: è®¾å®šç”Ÿæˆï¼ˆGenerationï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AI åŸºäºä¸Šä¸‹æ–‡åˆ›ä½œæ–°è®¾å®š                          â”‚ â”‚
â”‚  â”‚ - å¼•ç”¨å·²æœ‰è¯æ¡ï¼ˆå¦‚"æ¶ˆè€—ï¼šçµåŠ›ï¼ˆè§èƒ½é‡ä½“ç³»ï¼‰"ï¼‰  â”‚ â”‚
â”‚  â”‚ - éµå®ˆçº¦æŸè§„åˆ™                                   â”‚ â”‚
â”‚  â”‚ - ç”Ÿæˆæ–°ç‰ˆæœ¬ï¼ˆä¸è‡ªåŠ¨é‡‡çº³ï¼‰                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 3: ä¸€è‡´æ€§éªŒè¯ï¼ˆValidationï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. æ£€æŸ¥å¼•ç”¨æœ‰æ•ˆæ€§                                â”‚ â”‚
â”‚  â”‚ 2. æ£€æŸ¥é€»è¾‘ä¸€è‡´æ€§                                â”‚ â”‚
â”‚  â”‚ 3. æ ‡æ³¨æ½œåœ¨å†²çª                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 4: ç”¨æˆ·å®¡é˜…ä¸é‡‡çº³ï¼ˆReview & Adoptï¼‰             â”‚
â”‚  - æŸ¥çœ‹ç”Ÿæˆå†…å®¹                                        â”‚
â”‚  - æŸ¥çœ‹å¼•ç”¨çš„è¯æ¡                                      â”‚
â”‚  - é‡‡çº³æˆ–é‡æ–°ç”Ÿæˆ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸‰ç§æœç´¢ç­–ç•¥

#### 2.2.1 Vector Searchï¼ˆè¯­ä¹‰æœç´¢ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ‰¾ç›¸å…³ä½†ä¸ç²¾ç¡®åŒ¹é…çš„è¯æ¡

**å®ç°**ï¼š
```typescript
interface VectorSearchResult {
  nodeId: string
  title: string
  summary: string
  similarity: number  // 0-1
  path: string[]      // è·¯å¾„ï¼ˆå¦‚ ["ä¸–ç•Œè§‚", "é­”æ³•ä½“ç³»", "å…ƒç´ é­”æ³•"]ï¼‰
}

async function vectorSearch(
  query: string,
  topK: number = 5,
  filters?: {
    nodeTypes?: string[]  // åªæœç´¢ç‰¹å®šç±»å‹
    minSimilarity?: number
  }
): Promise<VectorSearchResult[]>
```

**ç¤ºä¾‹**ï¼š
```
æŸ¥è¯¢ï¼š"é›·ç”µé­”æ³•"
ç»“æœï¼š
  1. å…ƒç´ é­”æ³• (similarity: 0.92)
  2. èƒ½é‡ä½“ç³» (similarity: 0.85)
  3. é­”æ³•é™åˆ¶ (similarity: 0.78)
```

#### 2.2.2 Graph Searchï¼ˆä¾èµ–å›¾æœç´¢ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ‰¾ç›´æ¥æˆ–é—´æ¥ä¾èµ–çš„è¯æ¡

**å®ç°**ï¼š
```typescript
interface GraphSearchResult {
  nodeId: string
  title: string
  relationshipType: 'parent' | 'child' | 'reference' | 'derivedFrom'
  distance: number  // è·³æ•°
}

async function graphSearch(
  startNodeId: string,
  options: {
    direction?: 'upstream' | 'downstream' | 'both'  // ä¸Šæ¸¸ä¾èµ–/ä¸‹æ¸¸å¼•ç”¨/åŒå‘
    maxDepth?: number
    relationshipTypes?: string[]
  }
): Promise<GraphSearchResult[]>
```

**ç¤ºä¾‹**ï¼š
```
èµ·ç‚¹ï¼šæŠ€èƒ½èŠ‚ç‚¹ï¼ˆæ–°åˆ›å»ºï¼‰
æœç´¢ä¸Šæ¸¸ä¾èµ–ï¼ˆdistance <= 2ï¼‰ï¼š
  - æŠ€èƒ½æ ‘ (parent, distance: 1)
  - èƒ½é‡ä½“ç³» (reference, distance: 2)
  - èµ„æºç³»ç»Ÿ (reference, distance: 2)
```

#### 2.2.3 Grep Searchï¼ˆå…³é”®è¯æœç´¢ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç²¾ç¡®åŒ¹é…ç‰¹å®šæœ¯è¯­

**å®ç°**ï¼š
```typescript
interface GrepSearchResult {
  nodeId: string
  title: string
  matchedField: string  // åŒ¹é…çš„å­—æ®µ
  matchedText: string   // åŒ¹é…çš„æ–‡æœ¬ç‰‡æ®µ
  context: string       // ä¸Šä¸‹æ–‡ï¼ˆå‰åå„50å­—ï¼‰
}

async function grepSearch(
  pattern: string | RegExp,
  options: {
    fields?: string[]  // æœç´¢å“ªäº›å­—æ®µï¼ˆtitle, content, tagsç­‰ï¼‰
    nodeTypes?: string[]
    caseSensitive?: boolean
  }
): Promise<GrepSearchResult[]>
```

**ç¤ºä¾‹**ï¼š
```
æœç´¢ï¼š"çµåŠ›"
ç»“æœï¼š
  - èƒ½é‡ä½“ç³» > çµåŠ›ï¼šä¿®ç‚¼è€…ä»å¤©åœ°é—´å¸æ”¶çš„èƒ½é‡...
  - ä¿®ç‚¼ç­‰çº§ > çµåŠ›å€¼ï¼šæ¯æå‡ä¸€çº§ï¼ŒçµåŠ›å€¼+100...
  - æŠ€èƒ½ï¼šé›·éœ†æœ¯ > æ¶ˆè€—ï¼šéœ€è¦æ¶ˆè€—50ç‚¹çµåŠ›...
```

---

## 3. AI Agent å·¥å…·é“¾è®¾è®¡

### 3.1 æ ¸å¿ƒå·¥å…·æ¸…å•

#### å·¥å…· 1: `search_existing_entries`

**åŠŸèƒ½**ï¼šæœç´¢å·²æœ‰è¯æ¡ï¼Œç†è§£ä¸Šä¸‹æ–‡

```json
{
  "name": "search_existing_entries",
  "description": "æœç´¢å·²æœ‰çš„ä¸–ç•Œè§‚è¯æ¡ã€‚åˆ›å»ºæ–°è®¾å®šå‰å¿…é¡»å…ˆè°ƒç”¨æ­¤å·¥å…·ï¼Œäº†è§£ç›¸å…³çš„å·²æœ‰å†…å®¹ã€‚",
  "parameters": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "æœç´¢æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯å…³é”®è¯æˆ–é—®é¢˜"
      },
      "searchType": {
        "type": "string",
        "enum": ["vector", "graph", "grep", "hybrid"],
        "description": "æœç´¢ç±»å‹ï¼švector=è¯­ä¹‰æœç´¢ï¼Œgraph=ä¾èµ–å›¾æœç´¢ï¼Œgrep=å…³é”®è¯æœç´¢ï¼Œhybrid=ç»„åˆæœç´¢"
      },
      "nodeTypes": {
        "type": "array",
        "items": { "type": "string" },
        "description": "é™åˆ¶æœç´¢çš„èŠ‚ç‚¹ç±»å‹ï¼Œå¦‚ ['world.magic', 'world.resource']"
      },
      "maxResults": {
        "type": "number",
        "default": 10,
        "description": "è¿”å›æœ€å¤šå¤šå°‘ä¸ªç»“æœ"
      }
    },
    "required": ["query"]
  }
}
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "results": [
    {
      "nodeId": "node_123",
      "title": "å…ƒç´ é­”æ³•ä½“ç³»",
      "type": "world.magic.system",
      "summary": "åŸºäºäº”è¡Œå…ƒç´ çš„é­”æ³•ä½“ç³»ï¼ŒåŒ…æ‹¬é‡‘ã€æœ¨ã€æ°´ã€ç«ã€åœŸ...",
      "relevantFields": {
        "èƒ½é‡æ¥æº": "å¤©åœ°çµæ°”",
        "æ–½æ³•æ–¹å¼": "æ‰‹åŠ¿+å’’è¯­",
        "é™åˆ¶": "éœ€è¦ä¿®ç‚¼åˆ°ç­‘åŸºæœŸæ‰èƒ½æ–½æ”¾å…ƒç´ é­”æ³•"
      },
      "path": ["ä¸–ç•Œè§‚", "é­”æ³•ä½“ç³»", "å…ƒç´ é­”æ³•"],
      "similarity": 0.92
    },
    {
      "nodeId": "node_456",
      "title": "çµåŠ›ç³»ç»Ÿ",
      "type": "world.resource",
      "summary": "ä¿®ç‚¼è€…çš„èƒ½é‡èµ„æºï¼Œé€šè¿‡ä¿®ç‚¼ç§¯ç´¯...",
      "relevantFields": {
        "è·å–æ–¹å¼": "æ‰“åä¿®ç‚¼ã€å¸æ”¶çµçŸ³",
        "æ¶ˆè€—": "æ–½æ³•ã€ç‚¼ä¸¹ã€ç‚¼å™¨",
        "ä¸Šé™": "ç”±ä¿®ç‚¼å¢ƒç•Œå†³å®š"
      },
      "similarity": 0.85
    }
  ],
  "totalCount": 2
}
```

#### å·¥å…· 2: `get_entry_details`

**åŠŸèƒ½**ï¼šè·å–è¯æ¡çš„å®Œæ•´å†…å®¹

```json
{
  "name": "get_entry_details",
  "description": "è·å–æŸä¸ªè¯æ¡çš„å®Œæ•´å†…å®¹å’Œæ‰€æœ‰å­—æ®µã€‚ç”¨äºæ·±å…¥äº†è§£æŸä¸ªå·²æœ‰è®¾å®šã€‚",
  "parameters": {
    "type": "object",
    "properties": {
      "nodeId": {
        "type": "string",
        "description": "è¯æ¡çš„èŠ‚ç‚¹ ID"
      },
      "includeRelations": {
        "type": "boolean",
        "default": true,
        "description": "æ˜¯å¦åŒ…å«å…³è”è¯æ¡åˆ—è¡¨"
      }
    },
    "required": ["nodeId"]
  }
}
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "nodeId": "node_123",
  "title": "å…ƒç´ é­”æ³•ä½“ç³»",
  "type": "world.magic.system",
  "fields": {
    "åç§°": "å…ƒç´ é­”æ³•",
    "åˆ†ç±»": "å…ƒç´ ç³»",
    "èƒ½é‡æ¥æº": "å¤©åœ°çµæ°”ï¼Œé€šè¿‡äº”è¡Œå…ƒç´ è½¬åŒ–",
    "æ–½æ³•æ–¹å¼": "ä¿®ç‚¼è€…éœ€è¦æŒæ¡å¯¹åº”å…ƒç´ çš„æ‰‹åŠ¿å’Œå’’è¯­",
    "é™åˆ¶æ¡ä»¶": "1. éœ€è¦ç­‘åŸºæœŸä»¥ä¸Šå¢ƒç•Œ\n2. æ¯ä¸ªä¿®ç‚¼è€…æœ€å¤šæŒæ¡3ç§å…ƒç´ ",
    "è‘—åæ³•æœ¯": ["ç«çƒæœ¯", "æ°´éæœ¯", "åœŸå¢™æœ¯"]
  },
  "relations": {
    "dependsOn": [
      { "nodeId": "node_456", "title": "çµåŠ›ç³»ç»Ÿ", "type": "dependency" }
    ],
    "referencedBy": [
      { "nodeId": "node_789", "title": "ç«çƒæœ¯", "type": "skill" }
    ]
  },
  "memo": "å…ƒç´ é­”æ³•æ˜¯ä¿®çœŸä¸–ç•Œæœ€åŸºç¡€çš„é­”æ³•ä½“ç³»...",
  "path": ["ä¸–ç•Œè§‚", "é­”æ³•ä½“ç³»", "å…ƒç´ é­”æ³•"],
  "createdAt": "2025-12-13T10:00:00Z",
  "updatedAt": "2025-12-13T12:30:00Z"
}
```

#### å·¥å…· 3: `analyze_dependencies`

**åŠŸèƒ½**ï¼šåˆ†æåˆ›å»ºæŸç±»è¯æ¡éœ€è¦å“ªäº›ä¾èµ–

```json
{
  "name": "analyze_dependencies",
  "description": "åˆ†æåˆ›å»ºæŸç±»è¯æ¡éœ€è¦å¼•ç”¨å“ªäº›å·²æœ‰è®¾å®šã€‚å¸®åŠ©AIç†è§£éœ€è¦äº†è§£ä»€ä¹ˆã€‚",
  "parameters": {
    "type": "object",
    "properties": {
      "targetType": {
        "type": "string",
        "description": "è¦åˆ›å»ºçš„è¯æ¡ç±»å‹ï¼Œå¦‚ 'skill', 'character', 'magic'"
      },
      "userIntent": {
        "type": "string",
        "description": "ç”¨æˆ·çš„åˆ›ä½œæ„å›¾æè¿°"
      }
    },
    "required": ["targetType"]
  }
}
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "targetType": "skill",
  "requiredDependencies": [
    {
      "type": "world.magic.system",
      "reason": "æŠ€èƒ½éœ€è¦åŸºäºæŸä¸ªé­”æ³•ä½“ç³»",
      "searchSuggestion": "æœç´¢ä¸æŠ€èƒ½ç›¸å…³çš„é­”æ³•ä½“ç³»"
    },
    {
      "type": "world.resource",
      "reason": "æŠ€èƒ½éœ€è¦æ¶ˆè€—èµ„æºï¼ˆå¦‚çµåŠ›ã€æ³•åŠ›ï¼‰",
      "searchSuggestion": "æœç´¢èƒ½é‡èµ„æºç³»ç»Ÿ"
    },
    {
      "type": "skill.tree",
      "reason": "æŠ€èƒ½åº”è¯¥å±äºæŸä¸ªæŠ€èƒ½æ ‘",
      "searchSuggestion": "æœç´¢æŠ€èƒ½æ ‘æˆ–æŠ€èƒ½åˆ†ç±»"
    }
  ],
  "optionalDependencies": [
    {
      "type": "character",
      "reason": "å¯ä»¥å…³è”åˆ°ç‰¹å®šè§’è‰²ï¼ˆå¦‚ä¸“å±æŠ€èƒ½ï¼‰"
    }
  ]
}
```

#### å·¥å…· 4: `create_entry_with_context`

**åŠŸèƒ½**ï¼šåŸºäºå·²æœ‰ä¸Šä¸‹æ–‡åˆ›å»ºæ–°è¯æ¡

```json
{
  "name": "create_entry_with_context",
  "description": "åˆ›å»ºæ–°è¯æ¡ã€‚å¿…é¡»å…ˆç”¨ search_existing_entries äº†è§£ä¸Šä¸‹æ–‡ã€‚",
  "parameters": {
    "type": "object",
    "properties": {
      "title": {
        "type": "string",
        "description": "è¯æ¡æ ‡é¢˜"
      },
      "type": {
        "type": "string",
        "description": "è¯æ¡ç±»å‹ï¼Œå¦‚ 'skill', 'character', 'magic'"
      },
      "fields": {
        "type": "object",
        "description": "è¯æ¡å­—æ®µï¼Œæ ¹æ®æ¨¡æ¿å¡«å†™"
      },
      "references": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "nodeId": { "type": "string" },
            "relationship": { "type": "string" },
            "description": { "type": "string" }
          }
        },
        "description": "å¼•ç”¨çš„å·²æœ‰è¯æ¡ï¼Œè¯´æ˜å¼•ç”¨å…³ç³»"
      },
      "contextSummary": {
        "type": "string",
        "description": "è¯´æ˜åŸºäºå“ªäº›å·²æœ‰è®¾å®šåˆ›å»ºçš„ï¼ˆç”¨äºå®¡è®¡å’Œè§£é‡Šï¼‰"
      }
    },
    "required": ["title", "type", "fields", "contextSummary"]
  }
}
```

**è°ƒç”¨ç¤ºä¾‹**ï¼š
```json
{
  "title": "é›·éœ†æœ¯",
  "type": "skill",
  "fields": {
    "åç§°": "é›·éœ†æœ¯",
    "åˆ†ç±»": "é›·ç³»å…ƒç´ é­”æ³•",
    "å¨åŠ›": 8,
    "æ¶ˆè€—": "50ç‚¹çµåŠ›",
    "æ–½æ³•æ—¶é—´": "3ç§’",
    "å†·å´æ—¶é—´": "10ç§’",
    "æ•ˆæœ": "å¬å”¤å¤©é›·æ”»å‡»ç›®æ ‡ï¼Œé€ æˆå¤§é‡é›·å±æ€§ä¼¤å®³å¹¶æœ‰30%æ¦‚ç‡éº»ç—¹",
    "å­¦ä¹ æ¡ä»¶": "ç­‘åŸºæœŸï¼ŒæŒæ¡å…ƒç´ é­”æ³•åŸºç¡€"
  },
  "references": [
    {
      "nodeId": "node_123",
      "relationship": "basedOn",
      "description": "åŸºäºå…ƒç´ é­”æ³•ä½“ç³»ä¸­çš„é›·ç³»åˆ†æ”¯"
    },
    {
      "nodeId": "node_456",
      "relationship": "consumes",
      "description": "æ¶ˆè€—çµåŠ›ç³»ç»Ÿä¸­çš„çµåŠ›èµ„æº"
    }
  ],
  "contextSummary": "åŸºäºå·²æœ‰çš„'å…ƒç´ é­”æ³•ä½“ç³»'å’Œ'çµåŠ›ç³»ç»Ÿ'åˆ›å»ºã€‚æ¶ˆè€—50ç‚¹çµåŠ›ç¬¦åˆä¸­ç­‰å¨åŠ›æŠ€èƒ½çš„è®¾å®šï¼ˆå‚è€ƒç«çƒæœ¯40ç‚¹ï¼Œæ°´é¾™å·60ç‚¹ï¼‰ã€‚ç­‘åŸºæœŸå­¦ä¹ æ¡ä»¶ä¸å…ƒç´ é­”æ³•çš„é—¨æ§›ä¸€è‡´ã€‚"
}
```

#### å·¥å…· 5: `validate_consistency`

**åŠŸèƒ½**ï¼šéªŒè¯æ–°è®¾å®šä¸å·²æœ‰è®¾å®šçš„ä¸€è‡´æ€§

```json
{
  "name": "validate_consistency",
  "description": "éªŒè¯æ–°è®¾å®šæ˜¯å¦ä¸å·²æœ‰ä¸–ç•Œè§‚ä¿æŒä¸€è‡´ï¼Œæ£€æµ‹æ½œåœ¨å†²çª",
  "parameters": {
    "type": "object",
    "properties": {
      "newEntry": {
        "type": "object",
        "description": "æ–°è¯æ¡å†…å®¹"
      },
      "checkRules": {
        "type": "array",
        "items": { "type": "string" },
        "description": "è¦æ£€æŸ¥çš„è§„åˆ™ç±»å‹ï¼š['references', 'logic', 'naming', 'power_level']"
      }
    },
    "required": ["newEntry"]
  }
}
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "isValid": false,
  "issues": [
    {
      "severity": "error",
      "type": "reference_invalid",
      "message": "å¼•ç”¨çš„èŠ‚ç‚¹ 'node_999' ä¸å­˜åœ¨",
      "suggestion": "æ£€æŸ¥èƒ½é‡ä½“ç³»çš„æ­£ç¡®èŠ‚ç‚¹ ID"
    },
    {
      "severity": "warning",
      "type": "logic_conflict",
      "message": "æŠ€èƒ½æ¶ˆè€—50ç‚¹çµåŠ›ï¼Œä½†å¨åŠ›ç­‰çº§8åé«˜ã€‚æ ¹æ®å·²æœ‰æŠ€èƒ½ï¼Œ8çº§å¨åŠ›é€šå¸¸æ¶ˆè€—80-100ç‚¹çµåŠ›",
      "relatedEntries": ["ç«é¾™æœ¯ï¼ˆå¨åŠ›8ï¼Œæ¶ˆè€—90çµåŠ›ï¼‰", "å†°å°åƒé‡Œï¼ˆå¨åŠ›9ï¼Œæ¶ˆè€—120çµåŠ›ï¼‰"],
      "suggestion": "è€ƒè™‘é™ä½å¨åŠ›åˆ°6-7ï¼Œæˆ–å¢åŠ çµåŠ›æ¶ˆè€—åˆ°80+"
    },
    {
      "severity": "info",
      "type": "naming_convention",
      "message": "é›·ç³»æŠ€èƒ½é€šå¸¸ä»¥'é›·'æˆ–'ç”µ'å¼€å¤´ï¼Œ'é›·éœ†æœ¯'ç¬¦åˆå‘½åè§„èŒƒ",
      "examples": ["é›·éœ†ä¸‡é’§", "ç”µå…‰ç«çŸ³", "é›·äº‘æœ¯"]
    }
  ],
  "suggestions": [
    "å»ºè®®å°†å¨åŠ›è°ƒæ•´ä¸º7ï¼Œæˆ–å°†çµåŠ›æ¶ˆè€—æå‡è‡³70-80ç‚¹",
    "å¯ä»¥å¢åŠ 'éœ€è¦å¤©æ°”ä¸ºé›·é›¨'çš„é¢å¤–æ¡ä»¶æ¥å¹³è¡¡é«˜å¨åŠ›ä½æ¶ˆè€—"
  ]
}
```

#### å·¥å…· 6: `update_entry_with_context`

**åŠŸèƒ½**ï¼šåŸºäºä¸Šä¸‹æ–‡æ›´æ–°å·²æœ‰è¯æ¡

```json
{
  "name": "update_entry_with_context",
  "description": "æ›´æ–°å·²æœ‰è¯æ¡ã€‚æ›´æ–°å‰ä¼šè‡ªåŠ¨æœç´¢ç›¸å…³è¯æ¡ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚",
  "parameters": {
    "type": "object",
    "properties": {
      "nodeId": {
        "type": "string",
        "description": "è¦æ›´æ–°çš„è¯æ¡ ID"
      },
      "updates": {
        "type": "object",
        "description": "è¦æ›´æ–°çš„å­—æ®µ"
      },
      "reason": {
        "type": "string",
        "description": "æ›´æ–°åŸå› ï¼ˆä¾¿äºç‰ˆæœ¬è¿½è¸ªï¼‰"
      },
      "checkImpact": {
        "type": "boolean",
        "default": true,
        "description": "æ˜¯å¦æ£€æŸ¥å¯¹å…¶ä»–è¯æ¡çš„å½±å“"
      }
    },
    "required": ["nodeId", "updates", "reason"]
  }
}
```

---

## 4. äº¤äº’æµç¨‹è®¾è®¡ï¼šå®é™…åœºæ™¯æ¨¡æ‹Ÿ

### 4.1 åœºæ™¯ 1ï¼šåˆ›å»ºæŠ€èƒ½ï¼ˆå®Œæ•´æµç¨‹ï¼‰

**ç”¨æˆ·è¾“å…¥**ï¼š
```
åˆ›å»ºä¸€ä¸ªé›·ç”µé­”æ³•æŠ€èƒ½ï¼Œå«"é›·éœ†ä¸‡é’§"
```

**AI å·¥ä½œæµ**ï¼š

#### Step 1: ç†è§£æ„å›¾ï¼Œåˆ†æä¾èµ–

```
AI: æˆ‘æ¥å¸®ä½ åˆ›å»ºä¸€ä¸ªé›·ç”µé­”æ³•æŠ€èƒ½ã€‚é¦–å…ˆè®©æˆ‘äº†è§£ä¸€ä¸‹ä½ çš„ä¸–ç•Œè§‚è®¾å®šã€‚

[å†…éƒ¨] è°ƒç”¨ analyze_dependencies({
  targetType: "skill",
  userIntent: "åˆ›å»ºé›·ç”µé­”æ³•æŠ€èƒ½"
})

[è¿”å›] éœ€è¦äº†è§£ï¼šé­”æ³•ä½“ç³»ã€èƒ½é‡èµ„æºã€æŠ€èƒ½æ ‘
```

#### Step 2: æœç´¢å·²æœ‰è®¾å®š

```
AI: æ­£åœ¨æœç´¢ç›¸å…³çš„å·²æœ‰è®¾å®š...

[å†…éƒ¨] è°ƒç”¨ search_existing_entries({
  query: "é­”æ³•ä½“ç³» èƒ½é‡ é›·ç”µ",
  searchType: "hybrid",
  nodeTypes: ["world.magic", "world.resource", "skill.tree"]
})

[è¿”å›]
- å…ƒç´ é­”æ³•ä½“ç³»ï¼ˆsimilarity: 0.95ï¼‰
- çµåŠ›ç³»ç»Ÿï¼ˆsimilarity: 0.88ï¼‰
- ä¿®ç‚¼å¢ƒç•Œï¼ˆsimilarity: 0.72ï¼‰

AI: æˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹ç›¸å…³è®¾å®šï¼š
1. **å…ƒç´ é­”æ³•ä½“ç³»**ï¼šä½ çš„ä¸–ç•Œæœ‰åŸºäºäº”è¡Œçš„å…ƒç´ é­”æ³•
2. **çµåŠ›ç³»ç»Ÿ**ï¼šæŠ€èƒ½éœ€è¦æ¶ˆè€—çµåŠ›
3. **ä¿®ç‚¼å¢ƒç•Œ**ï¼šæŠ€èƒ½æœ‰å­¦ä¹ é—¨æ§›

è®©æˆ‘æŸ¥çœ‹è¯¦ç»†å†…å®¹...
```

#### Step 3: è·å–è¯¦ç»†ä¿¡æ¯

```
[å†…éƒ¨] è°ƒç”¨ get_entry_details({ nodeId: "node_123" })  // å…ƒç´ é­”æ³•ä½“ç³»
[å†…éƒ¨] è°ƒç”¨ get_entry_details({ nodeId: "node_456" })  // çµåŠ›ç³»ç»Ÿ

AI: æ ¹æ®ä½ çš„è®¾å®šï¼š
- å…ƒç´ é­”æ³•éœ€è¦**ç­‘åŸºæœŸ**æ‰èƒ½æ–½æ”¾
- çµåŠ›æ¶ˆè€—å‚è€ƒï¼šç«çƒæœ¯ï¼ˆ40ç‚¹ï¼‰ï¼Œæ°´é¾™å·ï¼ˆ60ç‚¹ï¼‰
- é›·ç³»å±äºé«˜æ”»å‡»åŠ›å…ƒç´ 

æˆ‘ç°åœ¨ä¸ºä½ è®¾è®¡"é›·éœ†ä¸‡é’§"æŠ€èƒ½...
```

#### Step 4: ç”Ÿæˆè®¾å®š

```
AI: æˆ‘ä¸ºä½ è®¾è®¡äº†è¿™ä¸ªæŠ€èƒ½ï¼š

ğŸ“œ **é›·éœ†ä¸‡é’§**

**åŸºæœ¬ä¿¡æ¯**ï¼š
- åˆ†ç±»ï¼šé›·ç³»å…ƒç´ é­”æ³•
- å¨åŠ›ï¼šâ˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜†â˜† (8/10)
- æ¶ˆè€—ï¼š80ç‚¹çµåŠ›
- æ–½æ³•æ—¶é—´ï¼š5ç§’
- å†·å´ï¼š15ç§’

**æ•ˆæœ**ï¼š
å¬å”¤å¤©ç©ºä¸­çš„é›·äº‘ï¼Œé™ä¸‹ä¹é“å¤©é›·è½°å‡»ç›®æ ‡åŒºåŸŸã€‚æ¯é“é›·éœ†é€ æˆå¤§é‡ä¼¤å®³ï¼Œå¹¶æœ‰50%æ¦‚ç‡éº»ç—¹æ•Œäºº3ç§’ã€‚

**å­¦ä¹ æ¡ä»¶**ï¼š
- ä¿®ä¸ºï¼šç­‘åŸºæœŸä¸­æœŸ
- å‰ç½®æŠ€èƒ½ï¼šé›·å‡»æœ¯ï¼ˆåˆçº§é›·ç³»é­”æ³•ï¼‰
- ç‰¹æ®Šè¦æ±‚ï¼šéœ€åœ¨é›·é›¨å¤©æ°”é¦–æ¬¡æ–½æ”¾æˆåŠŸ

**è®¾è®¡è¯´æ˜**ï¼š
- æ¶ˆè€—80çµåŠ›æ˜¯åŸºäºå¨åŠ›8çº§çš„æ ‡å‡†ï¼ˆå‚è€ƒç«é¾™æœ¯ï¼šå¨åŠ›8ï¼Œæ¶ˆè€—90çµåŠ›ï¼‰
- ç­‘åŸºæœŸä¸­æœŸé—¨æ§›ä¸å…ƒç´ é­”æ³•ä½“ç³»ä¸€è‡´
- æ·»åŠ äº†"é›·é›¨å¤©é¦–æ¬¡æ–½æ”¾"çš„è®¾å®šï¼Œå¢åŠ ä»ªå¼æ„Ÿ

è¦åˆ›å»ºè¿™ä¸ªæŠ€èƒ½å—ï¼Ÿæˆ‘ä¼šè‡ªåŠ¨å…³è”åˆ°"å…ƒç´ é­”æ³•ä½“ç³»"å’Œ"çµåŠ›ç³»ç»Ÿ"ã€‚
```

#### Step 5: éªŒè¯ä¸€è‡´æ€§

```
[å†…éƒ¨] è°ƒç”¨ validate_consistency({
  newEntry: { ... },
  checkRules: ["references", "logic", "power_level"]
})

[è¿”å›]
- âœ“ å¼•ç”¨æœ‰æ•ˆ
- âš  å¨åŠ›8æ¶ˆè€—80çµåŠ›åä½ï¼Œå»ºè®®90+
- âœ“ å‘½åç¬¦åˆè§„èŒƒ

AI: æ£€æµ‹åˆ°ä¸€ä¸ªå°é—®é¢˜ï¼š
âš ï¸ æ ¹æ®å·²æœ‰æŠ€èƒ½ï¼Œå¨åŠ›8çº§é€šå¸¸æ¶ˆè€—90-100ç‚¹çµåŠ›ã€‚å½“å‰è®¾ç½®ä¸º80ç‚¹ç•¥ä½ã€‚

å»ºè®®ï¼š
1. å°†çµåŠ›æ¶ˆè€—æå‡åˆ°90ç‚¹ï¼ˆæ¨èï¼‰
2. æˆ–è€…å¢åŠ é¢å¤–é™åˆ¶æ¥å¹³è¡¡ï¼ˆå¦‚"éœ€è¦é›·é›¨å¤©æ‰èƒ½æ–½æ”¾"ï¼‰

ä½ æƒ³å¦‚ä½•è°ƒæ•´ï¼Ÿ
```

**ç”¨æˆ·å›å¤**ï¼š
```
åŠ ä¸Šé›·é›¨å¤©çš„é™åˆ¶å§ï¼Œè¿™æ ·æ›´æœ‰æ„å¢ƒ
```

#### Step 6: åˆ›å»ºè¯æ¡

```
AI: å¥½çš„ï¼æ·»åŠ é›·é›¨å¤©é™åˆ¶ï¼Œè¿™æ ·å¨åŠ›å’Œæ¶ˆè€—çš„æ¯”ä¾‹å°±åˆç†äº†ã€‚æ­£åœ¨åˆ›å»º...

[å†…éƒ¨] è°ƒç”¨ create_entry_with_context({
  title: "é›·éœ†ä¸‡é’§",
  type: "skill",
  fields: { ... },
  references: [
    { nodeId: "node_123", relationship: "basedOn", description: "åŸºäºå…ƒç´ é­”æ³•ä½“ç³»" },
    { nodeId: "node_456", relationship: "consumes", description: "æ¶ˆè€—çµåŠ›" }
  ],
  contextSummary: "åŸºäºå…ƒç´ é­”æ³•å’ŒçµåŠ›ç³»ç»Ÿåˆ›å»ºã€‚å¨åŠ›8çº§é…åˆ80çµåŠ›æ¶ˆè€—ï¼Œé€šè¿‡é›·é›¨å¤©é™åˆ¶å¹³è¡¡ã€‚"
})

AI: âœ… æŠ€èƒ½"é›·éœ†ä¸‡é’§"åˆ›å»ºæˆåŠŸï¼

å·²è‡ªåŠ¨å…³è”ï¼š
- å…ƒç´ é­”æ³•ä½“ç³» â†’ é›·ç³»åˆ†æ”¯
- çµåŠ›ç³»ç»Ÿ â†’ æ¶ˆè€—80ç‚¹

ä½ å¯ä»¥åœ¨æŠ€èƒ½æ ‘ä¸­çœ‹åˆ°è¿™ä¸ªæ–°æŠ€èƒ½ã€‚è¦ç»§ç»­åˆ›å»ºç›¸å…³çš„è¿›é˜¶æŠ€èƒ½å—ï¼Ÿ
```

### 4.2 åœºæ™¯ 2ï¼šä¿®æ”¹èƒ½é‡ä½“ç³»ï¼Œå½±å“åˆ†æ

**ç”¨æˆ·è¾“å…¥**ï¼š
```
æˆ‘æƒ³æŠŠçµåŠ›ç³»ç»Ÿæ”¹æˆ"çœŸæ°”ç³»ç»Ÿ"ï¼Œæ‰€æœ‰æŠ€èƒ½çš„æ¶ˆè€—éƒ½æ”¹æˆçœŸæ°”
```

**AI å·¥ä½œæµ**ï¼š

#### Step 1: å½±å“åˆ†æ

```
AI: è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„ä¿®æ”¹ã€‚è®©æˆ‘å…ˆåˆ†æå½±å“èŒƒå›´...

[å†…éƒ¨] è°ƒç”¨ graphSearch({
  startNodeId: "node_456",  // çµåŠ›ç³»ç»Ÿ
  direction: "downstream",
  maxDepth: 3
})

[è¿”å›] æ‰¾åˆ°23ä¸ªå¼•ç”¨çµåŠ›ç³»ç»Ÿçš„è¯æ¡ï¼š
- 15ä¸ªæŠ€èƒ½
- 5ä¸ªè§’è‰²ï¼ˆä¿®ç‚¼è€…ï¼‰
- 3ä¸ªè£…å¤‡

AI: âš ï¸ æ£€æµ‹åˆ°**23ä¸ªè¯æ¡**å¼•ç”¨äº†"çµåŠ›ç³»ç»Ÿ"ï¼š

**å—å½±å“çš„å†…å®¹**ï¼š
1. æŠ€èƒ½ï¼ˆ15ä¸ªï¼‰ï¼šç«çƒæœ¯ã€æ°´é¾™å·ã€é›·éœ†ä¸‡é’§...
2. è§’è‰²ï¼ˆ5ä¸ªï¼‰ï¼šä¸»è§’ã€å¯¼å¸ˆ...
3. è£…å¤‡ï¼ˆ3ä¸ªï¼‰ï¼šçµçŸ³ã€èšçµé˜µ...

**å»ºè®®çš„å¤„ç†æ–¹å¼**ï¼š
1. **æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**ï¼šæ‰¹é‡æ›´æ–°æ‰€æœ‰å¼•ç”¨ï¼Œå°†"çµåŠ›"æ›¿æ¢ä¸º"çœŸæ°”"
2. **æ–¹æ¡ˆB**ï¼šåˆ›å»º"çœŸæ°”ç³»ç»Ÿ"ä½œä¸ºæ–°è¯æ¡ï¼Œä¸çµåŠ›å¹¶å­˜ï¼ˆåŒä¿®ä½“ç³»ï¼‰
3. **æ–¹æ¡ˆC**ï¼šä»…ä¿®æ”¹æ ¸å¿ƒè®¾å®šï¼Œæ‰‹åŠ¨å®¡æŸ¥æ¯ä¸ªå¼•ç”¨

ä½ æƒ³é‡‡ç”¨å“ªç§æ–¹å¼ï¼Ÿ
```

**ç”¨æˆ·å›å¤**ï¼š
```
æ–¹æ¡ˆAï¼Œå…¨éƒ¨æ›¿æ¢
```

#### Step 2: æ‰¹é‡æ›´æ–°

```
AI: å¥½çš„ï¼Œæˆ‘ä¼šé€ä¸ªæ›´æ–°è¿™äº›è¯æ¡ã€‚è¿™æ˜¯æ›´æ–°è®¡åˆ’ï¼š

**ç¬¬1æ­¥**ï¼šæ›´æ–°æ ¸å¿ƒè®¾å®š
- çµåŠ›ç³»ç»Ÿ â†’ çœŸæ°”ç³»ç»Ÿ

**ç¬¬2æ­¥**ï¼šæ›´æ–°æ‰€æœ‰æŠ€èƒ½çš„æ¶ˆè€—æè¿°
- "æ¶ˆè€—ï¼šXXç‚¹çµåŠ›" â†’ "æ¶ˆè€—ï¼šXXç‚¹çœŸæ°”"

**ç¬¬3æ­¥**ï¼šæ›´æ–°è§’è‰²å±æ€§
- "çµåŠ›å€¼ï¼šXXX" â†’ "çœŸæ°”å€¼ï¼šXXX"

**ç¬¬4æ­¥**ï¼šæ›´æ–°è£…å¤‡è¯´æ˜
- "å¢åŠ çµåŠ›ä¸Šé™" â†’ "å¢åŠ çœŸæ°”ä¸Šé™"

å¼€å§‹æ›´æ–°å—ï¼Ÿï¼ˆä¼šåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä½ å¯ä»¥éšæ—¶å›é€€ï¼‰
```

**ç”¨æˆ·ç¡®è®¤å**ï¼š

```
AI: æ­£åœ¨æ›´æ–°...

âœ“ 1/23 çœŸæ°”ç³»ç»Ÿï¼ˆæ ¸å¿ƒè®¾å®šï¼‰
âœ“ 2/23 ç«çƒæœ¯
âœ“ 3/23 æ°´é¾™å·
...
âœ“ 23/23 èšçµé˜µ â†’ èšæ°”é˜µ

âœ… æ‰€æœ‰è¯æ¡å·²æ›´æ–°ï¼

**å˜æ›´æ‘˜è¦**ï¼š
- æ ¸å¿ƒè®¾å®šï¼š1ä¸ª
- æŠ€èƒ½ï¼š15ä¸ª
- è§’è‰²ï¼š5ä¸ª
- è£…å¤‡ï¼š3ä¸ª

æ‰€æœ‰æ›´æ–°å·²ä¿å­˜ä¸ºæ–°ç‰ˆæœ¬ã€‚ä½ å¯ä»¥åœ¨ç‰ˆæœ¬å†å²ä¸­æŸ¥çœ‹è¯¦ç»†å˜æ›´ã€‚

éœ€è¦æˆ‘ç”Ÿæˆä¸€ä»½å˜æ›´æ—¥å¿—å—ï¼Ÿ
```

### 4.3 åœºæ™¯ 3ï¼šå‘ç°é—æ¼çš„è®¾å®š

**ç”¨æˆ·è¾“å…¥**ï¼š
```
åˆ›å»ºä¸€ä¸ªè§’è‰²ï¼Œå«æé€é¥ï¼Œæ˜¯ä¸ªå‰‘ä¿®
```

**AI å·¥ä½œæµ**ï¼š

```
AI: æˆ‘æ¥åˆ›å»ºè§’è‰²"æé€é¥"ã€‚é¦–å…ˆæœç´¢ç›¸å…³è®¾å®š...

[å†…éƒ¨] è°ƒç”¨ search_existing_entries({
  query: "å‰‘ä¿® ä¿®ç‚¼ èŒä¸š",
  searchType: "hybrid"
})

[è¿”å›] æœªæ‰¾åˆ°"å‰‘ä¿®"ç›¸å…³è¯æ¡

AI: âš ï¸ æˆ‘å‘ç°ä½ çš„ä¸–ç•Œè§‚ä¸­è¿˜æ²¡æœ‰"å‰‘ä¿®"ç›¸å…³çš„è®¾å®šã€‚

**å»ºè®®**ï¼š
1. å…ˆåˆ›å»º"å‰‘ä¿®ä½“ç³»"è¯æ¡ï¼Œå®šä¹‰ï¼š
   - å‰‘ä¿®çš„ä¿®ç‚¼æ–¹å¼
   - ä¸æ³•ä¿®ã€ä½“ä¿®çš„åŒºåˆ«
   - æ ¸å¿ƒèƒ½åŠ›å’Œç‰¹ç‚¹
   
2. ç„¶ååŸºäº"å‰‘ä¿®ä½“ç³»"åˆ›å»ºè§’è‰²"æé€é¥"

**å¿«æ·é€‰é¡¹**ï¼š
A. æˆ‘å¸®ä½ ç”Ÿæˆä¸€ä¸ªæ ‡å‡†çš„"å‰‘ä¿®ä½“ç³»"è®¾å®šï¼ˆåŸºäºå¸¸è§ä¿®çœŸè®¾å®šï¼‰
B. ä½ å‘Šè¯‰æˆ‘ä½ æƒ³è¦çš„å‰‘ä¿®ç‰¹ç‚¹ï¼Œæˆ‘å¸®ä½ è®¾è®¡
C. è·³è¿‡ï¼Œå…ˆåˆ›å»ºè§’è‰²ï¼ˆå¯èƒ½ä¸å…¶ä»–è®¾å®šä¸ä¸€è‡´ï¼‰

ä½ æƒ³é€‰æ‹©å“ªä¸ªï¼Ÿ
```

**ç”¨æˆ·å›å¤**ï¼š
```
é€‰Aï¼Œç”Ÿæˆæ ‡å‡†çš„å‰‘ä¿®ä½“ç³»
```

```
AI: å¥½çš„ï¼æˆ‘åŸºäºå¸¸è§ä¿®çœŸå°è¯´è®¾å®šï¼Œä¸ºä½ ç”Ÿæˆ"å‰‘ä¿®ä½“ç³»"ï¼š

ğŸ“œ **å‰‘ä¿®ä½“ç³»**

**å®šä¹‰**ï¼š
ä»¥å‰‘ä¸ºæœ¬å‘½æ³•å™¨ï¼Œè¿½æ±‚"äººå‰‘åˆä¸€"çš„ä¿®ç‚¼è€…ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- æ”»å‡»åŠ›ï¼šâ˜…â˜…â˜…â˜…â˜…ï¼ˆæœ€å¼ºï¼‰
- é˜²å¾¡åŠ›ï¼šâ˜…â˜…â˜†â˜†â˜†ï¼ˆæœ€å¼±ï¼‰
- æ¶ˆè€—ï¼šçœŸæ°” + å‰‘æ„ï¼ˆç‰¹æ®Šèµ„æºï¼‰

**ä¿®ç‚¼æ–¹å¼**ï¼š
1. ç‚¼å‰‘ï¼šé“¸é€ æˆ–å¯»æ‰¾æœ¬å‘½å‰‘
2. å…»å‰‘ï¼šä»¥çœŸæ°”æ¸©å…»ï¼Œæå‡å¥‘åˆåº¦
3. å‰‘æ„ï¼šé¢†æ‚Ÿå‰‘æ„ï¼Œå¢ƒç•Œåˆ†ä¸ºï¼šå‰‘æ°”ã€å‰‘èŠ’ã€å‰‘åŸŸã€å‰‘æ„

**ä¸å…¶ä»–ä½“ç³»çš„åŒºåˆ«**ï¼š
- æ³•ä¿®ï¼šæ“…é•¿å¤šæ ·æ³•æœ¯ï¼Œä½†å•ä½“æ”»å‡»ä¸å¦‚å‰‘ä¿®
- ä½“ä¿®ï¼šé˜²å¾¡åŠ›å¼ºï¼Œä½†é€Ÿåº¦å’Œçµæ´»æ€§ä¸å¦‚å‰‘ä¿®
- å‰‘ä¿®ï¼šæè‡´çš„å•ä½“æ”»å‡»å’Œé€Ÿåº¦ï¼Œä½†é˜²å¾¡è„†å¼±

è¦åˆ›å»ºè¿™ä¸ªè®¾å®šå—ï¼Ÿåˆ›å»ºåæˆ‘ä¼šåŸºäºå®ƒæ¥è®¾è®¡è§’è‰²"æé€é¥"ã€‚
```

---

## 5. æŠ€æœ¯å®ç°æ¶æ„

### 5.1 ç³»ç»Ÿç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent Orchestratorï¼ˆä¸»æ§ï¼‰                             â”‚
â”‚  - å·¥ä½œæµç¼–æ’                                           â”‚
â”‚  - å·¥å…·è°ƒç”¨                                             â”‚
â”‚  - ä¸Šä¸‹æ–‡ç®¡ç†                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                   â”‚              â”‚                 â”‚
   â†“                   â†“              â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vector  â”‚      â”‚  Graph   â”‚  â”‚  Grep    â”‚    â”‚Validationâ”‚
â”‚ Search  â”‚      â”‚  Search  â”‚  â”‚  Search  â”‚    â”‚  Engine  â”‚
â”‚ Engine  â”‚      â”‚  Engine  â”‚  â”‚  Engine  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Node Tree Service  â”‚
            â”‚   - èŠ‚ç‚¹æŸ¥è¯¢         â”‚
            â”‚   - å…³ç³»å›¾è°±         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Capability System   â”‚
            â”‚  - KVå­˜å‚¨            â”‚
            â”‚  - Memoå­˜å‚¨          â”‚
            â”‚  - ç‰ˆæœ¬ç®¡ç†          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Vector Search å®ç°

**æ–¹æ¡ˆé€‰æ‹©**ï¼š
- **æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**ï¼šä½¿ç”¨ SQLite çš„ [sqlite-vss](https://github.com/asg017/sqlite-vss) æ‰©å±•
  - ä¼˜åŠ¿ï¼šä¸ç°æœ‰ SQLite æ•°æ®åº“é›†æˆ
  - åŠ£åŠ¿ï¼šéœ€è¦ç¼–è¯‘åŸç”Ÿæ‰©å±•
  
- **æ–¹æ¡ˆB**ï¼šä½¿ç”¨ [LanceDB](https://lancedb.com/)
  - ä¼˜åŠ¿ï¼šçº¯ Node.jsï¼Œæ˜“äºé›†æˆ
  - åŠ£åŠ¿ï¼šéœ€è¦é¢å¤–çš„æ•°æ®åº“

**å®ç°ç¤ºä¾‹ï¼ˆsqlite-vssï¼‰**ï¼š

```typescript
import Database from 'better-sqlite3'
import { embed } from './embeddings'  // OpenAI embeddings API

class VectorSearchService {
  private db: Database.Database
  
  async initialize() {
    this.db = new Database('storyteller.db')
    
    // åŠ è½½ sqlite-vss æ‰©å±•
    this.db.loadExtension('vss')
    
    // åˆ›å»ºå‘é‡è¡¨
    this.db.exec(`
      CREATE VIRTUAL TABLE IF NOT EXISTS node_embeddings USING vss0(
        embedding(1536)  -- OpenAI text-embedding-ada-002 ç»´åº¦
      );
      
      CREATE TABLE IF NOT EXISTS node_embedding_metadata (
        rowid INTEGER PRIMARY KEY,
        node_id TEXT NOT NULL,
        title TEXT,
        summary TEXT,
        node_type TEXT,
        updated_at INTEGER
      );
    `)
  }
  
  async indexNode(nodeId: string, content: string) {
    // 1. ç”ŸæˆåµŒå…¥å‘é‡
    const embeddingVector = await embed(content)
    
    // 2. æ’å…¥å‘é‡
    const info = this.db.prepare(`
      INSERT INTO node_embeddings(rowid, embedding)
      VALUES (?, ?)
    `).run(null, embeddingVector)
    
    const rowid = info.lastInsertRowid
    
    // 3. æ’å…¥å…ƒæ•°æ®
    this.db.prepare(`
      INSERT INTO node_embedding_metadata(rowid, node_id, title, summary, node_type, updated_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `).run(rowid, nodeId, ...)
  }
  
  async search(query: string, topK: number = 5): Promise<VectorSearchResult[]> {
    // 1. ç”ŸæˆæŸ¥è¯¢å‘é‡
    const queryVector = await embed(query)
    
    // 2. å‘é‡æœç´¢
    const results = this.db.prepare(`
      SELECT 
        m.node_id,
        m.title,
        m.summary,
        m.node_type,
        vss.distance AS similarity
      FROM node_embeddings vss
      JOIN node_embedding_metadata m ON m.rowid = vss.rowid
      WHERE vss_search(embedding, ?)
      LIMIT ?
    `).all(queryVector, topK)
    
    return results.map(r => ({
      nodeId: r.node_id,
      title: r.title,
      summary: r.summary,
      similarity: 1 - r.similarity,  // è½¬æ¢ä¸º 0-1 ç›¸ä¼¼åº¦
      path: this.getNodePath(r.node_id)
    }))
  }
}
```

### 5.3 Graph Search å®ç°

```typescript
class GraphSearchService {
  private db: Database.Database
  
  async searchUpstream(
    nodeId: string,
    maxDepth: number = 2
  ): Promise<GraphSearchResult[]> {
    // é€’å½’ CTE æŸ¥è¯¢ä¸Šæ¸¸ä¾èµ–
    const results = this.db.prepare(`
      WITH RECURSIVE dependencies(node_id, relation_type, depth) AS (
        -- åŸºç¡€æƒ…å†µï¼šèµ·ç‚¹èŠ‚ç‚¹
        SELECT ?, 'self', 0
        
        UNION ALL
        
        -- é€’å½’ï¼šæŸ¥æ‰¾å¼•ç”¨
        SELECT 
          nr.source_node_id,
          nr.relation_type,
          d.depth + 1
        FROM node_relations nr
        JOIN dependencies d ON d.node_id = nr.target_node_id
        WHERE d.depth < ?
      )
      SELECT DISTINCT 
        d.node_id,
        n.title,
        d.relation_type,
        d.depth AS distance
      FROM dependencies d
      JOIN nodes n ON n.id = d.node_id
      WHERE d.depth > 0
      ORDER BY d.depth, n.title
    `).all(nodeId, maxDepth)
    
    return results
  }
  
  async searchDownstream(
    nodeId: string,
    maxDepth: number = 2
  ): Promise<GraphSearchResult[]> {
    // æŸ¥æ‰¾ä¸‹æ¸¸å¼•ç”¨ï¼ˆåå‘ï¼‰
    const results = this.db.prepare(`
      WITH RECURSIVE references(node_id, relation_type, depth) AS (
        SELECT ?, 'self', 0
        
        UNION ALL
        
        SELECT 
          nr.target_node_id,
          nr.relation_type,
          r.depth + 1
        FROM node_relations nr
        JOIN references r ON r.node_id = nr.source_node_id
        WHERE r.depth < ?
      )
      SELECT DISTINCT 
        r.node_id,
        n.title,
        r.relation_type,
        r.depth AS distance
      FROM references r
      JOIN nodes n ON n.id = r.node_id
      WHERE r.depth > 0
      ORDER BY r.depth, n.title
    `).all(nodeId, maxDepth)
    
    return results
  }
}
```

### 5.4 Agent Workflow ç¼–æ’

```typescript
class ContextAwareAgent {
  private tools: AgentTool[]
  private searchService: SearchService
  
  async handleUserIntent(intent: string): Promise<void> {
    // Phase 1: ç†è§£æ„å›¾
    const analysis = await this.analyzeIntent(intent)
    
    if (analysis.action === 'create') {
      await this.createWithContext(analysis)
    } else if (analysis.action === 'update') {
      await this.updateWithContext(analysis)
    }
  }
  
  private async createWithContext(analysis: IntentAnalysis) {
    // Step 1: åˆ†æä¾èµ–
    const dependencies = await this.call('analyze_dependencies', {
      targetType: analysis.targetType,
      userIntent: analysis.rawIntent
    })
    
    this.sendMessage(`åˆ›å»º${analysis.targetType}éœ€è¦äº†è§£ä»¥ä¸‹è®¾å®šï¼š\n${dependencies.map(d => `- ${d.type}: ${d.reason}`).join('\n')}`)
    
    // Step 2: æœç´¢å·²æœ‰è®¾å®š
    const searchResults = await this.call('search_existing_entries', {
      query: analysis.searchQuery,
      searchType: 'hybrid',
      nodeTypes: dependencies.map(d => d.type)
    })
    
    if (searchResults.results.length === 0) {
      this.sendMessage(`âš ï¸ æœªæ‰¾åˆ°ç›¸å…³è®¾å®šã€‚å»ºè®®å…ˆåˆ›å»ºï¼š${dependencies[0].type}`)
      return
    }
    
    this.sendMessage(`æ‰¾åˆ°${searchResults.results.length}ä¸ªç›¸å…³è®¾å®š...`)
    
    // Step 3: è·å–è¯¦ç»†ä¿¡æ¯
    const context = []
    for (const result of searchResults.results.slice(0, 3)) {
      const details = await this.call('get_entry_details', {
        nodeId: result.nodeId
      })
      context.push(details)
    }
    
    // Step 4: åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆ
    const generated = await this.generateContent(analysis, context)
    
    // Step 5: éªŒè¯ä¸€è‡´æ€§
    const validation = await this.call('validate_consistency', {
      newEntry: generated
    })
    
    if (validation.issues.length > 0) {
      this.sendMessage(`æ£€æµ‹åˆ°${validation.issues.length}ä¸ªé—®é¢˜ï¼š`)
      for (const issue of validation.issues) {
        this.sendMessage(`${issue.severity === 'error' ? 'âŒ' : 'âš ï¸'} ${issue.message}`)
      }
    }
    
    // Step 6: è¯¢é—®ç”¨æˆ·ç¡®è®¤
    const confirmed = await this.askConfirmation()
    if (confirmed) {
      await this.call('create_entry_with_context', {
        ...generated,
        contextSummary: this.buildContextSummary(context)
      })
      this.sendMessage('âœ… åˆ›å»ºæˆåŠŸï¼')
    }
  }
}
```

---

## 6. ç°æœ‰ä½“ç³»è¯„ä¼°ä¸æ”¹è¿›å»ºè®®

### 6.1 ç°æœ‰ä½“ç³»æ£€æŸ¥æ¸…å•

åŸºäºç°æœ‰æ–‡æ¡£ï¼ˆ`05-agent-tools.md`, `07-ai-coauthoring.md`ï¼‰ï¼Œè¯„ä¼°ï¼š

#### âœ… å·²æœ‰ä¸”è¶³å¤Ÿ

1. **Capability System**ï¼š
   - èƒ½åŠ›æ³¨å†Œæœºåˆ¶å®Œå–„
   - å·¥å…·è‡ªåŠ¨æš´éœ²ï¼ˆagent facetï¼‰
   - ç‰ˆæœ¬åŒ–å®Œæ•´

2. **Agent Runner**ï¼š
   - LangChain é›†æˆ
   - æµå¼è¾“å‡º
   - å·¥å…·è°ƒç”¨æ¡†æ¶

3. **IPC é€šä¿¡**ï¼š
   - ä¸»è¿›ç¨‹/æ¸²æŸ“è¿›ç¨‹åˆ†ç¦»
   - å·¥å…·è°ƒç”¨äº‹ä»¶åŒ–

#### âš ï¸ éœ€è¦å¢å¼º

1. **æœç´¢èƒ½åŠ›**ï¼š
   - âŒ ç¼ºå°‘ Vector Search
   - âŒ ç¼ºå°‘ Graph Search
   - âœ… æœ‰åŸºç¡€çš„èŠ‚ç‚¹æŸ¥è¯¢ï¼ˆnodeListï¼‰

2. **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼š
   - âŒ æ²¡æœ‰è‡ªåŠ¨ä¸Šä¸‹æ–‡æ”¶é›†
   - âŒ æ²¡æœ‰ä¾èµ–åˆ†æ
   - âŒ æ²¡æœ‰ä¸€è‡´æ€§éªŒè¯

3. **å·¥å…·é“¾**ï¼š
   - âœ… æœ‰åŸºç¡€ CRUD å·¥å…·
   - âŒ ç¼ºå°‘æœç´¢å·¥å…·
   - âŒ ç¼ºå°‘åˆ†æå·¥å…·
   - âŒ ç¼ºå°‘éªŒè¯å·¥å…·

### 6.2 æ”¹è¿›å»ºè®®

#### ä¼˜å…ˆçº§ P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

1. **å®ç° Hybrid Search Service**
   ```typescript
   // main/services/searchService.ts
   class SearchService {
     async search(query, options): Promise<SearchResult[]>
     async vectorSearch(query, topK): Promise<VectorSearchResult[]>
     async graphSearch(nodeId, direction, depth): Promise<GraphSearchResult[]>
     async grepSearch(pattern, options): Promise<GrepSearchResult[]>
   }
   ```

2. **æ·»åŠ æœç´¢ç›¸å…³ Agent Tools**
   ```typescript
   // main/agent/tools/search.ts
   - search_existing_entries
   - get_entry_details
   - analyze_dependencies
   ```

3. **å®ç° Context Manager**
   ```typescript
   // main/agent/contextManager.ts
   class ContextManager {
     async gatherContext(intent): Promise<Context>
     async buildPrompt(intent, context): Promise<string>
   }
   ```

#### ä¼˜å…ˆçº§ P1ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰

4. **å®ç° Validation Engine**
   ```typescript
   // main/services/validationService.ts
   class ValidationService {
     async validate(entry, rules): Promise<ValidationResult>
     async checkReferences(entry): Promise<ReferenceCheck>
     async checkLogic(entry, related): Promise<LogicCheck>
   }
   ```

5. **æ·»åŠ éªŒè¯ç›¸å…³ Agent Tools**
   ```typescript
   // main/agent/tools/validation.ts
   - validate_consistency
   - check_references
   - analyze_impact
   ```

6. **å¢å¼º System Prompt**
   ```typescript
   const systemPrompt = `
   ä½ æ˜¯ä¸€ä¸ªä¸–ç•Œè§‚è®¾å®šåŠ©æ‰‹ã€‚åˆ›ä½œæ–°è®¾å®šå‰ï¼Œä½ å¿…é¡»ï¼š
   
   1. ä½¿ç”¨ search_existing_entries æœç´¢ç›¸å…³è¯æ¡
   2. ä½¿ç”¨ get_entry_details äº†è§£è¯¦ç»†ä¿¡æ¯
   3. ä½¿ç”¨ analyze_dependencies åˆ†æä¾èµ–å…³ç³»
   4. åŸºäºå·²æœ‰è®¾å®šåˆ›ä½œæ–°å†…å®¹
   5. ä½¿ç”¨ validate_consistency éªŒè¯ä¸€è‡´æ€§
   
   åŸåˆ™ï¼š
   - æ–°è®¾å®šå¿…é¡»åŸºäºå·²æœ‰è®¾å®šï¼Œä¸èƒ½æ— ä¸­ç”Ÿæœ‰
   - æ‰€æœ‰å¼•ç”¨å¿…é¡»æœ‰æ•ˆ
   - ä¿æŒé€»è¾‘ä¸€è‡´æ€§
   - éµå®ˆä¸–ç•Œè§‚è§„åˆ™
   `
   ```

#### ä¼˜å…ˆçº§ P2ï¼ˆæœªæ¥æ‰©å±•ï¼‰

7. **çŸ¥è¯†å›¾è°±å¯è§†åŒ–**
   - å±•ç¤ºèŠ‚ç‚¹é—´çš„ä¾èµ–å…³ç³»
   - é«˜äº®å½±å“è·¯å¾„

8. **æ™ºèƒ½æ¨èç³»ç»Ÿ**
   - æ¨èç›¸å…³è¯æ¡
   - æ¨èå­—æ®µå¡«å……
   - æ¨èä¸€è‡´æ€§ä¿®å¤

---

## 7. å®æ–½è·¯çº¿

### é˜¶æ®µ 1ï¼šæœç´¢åŸºç¡€è®¾æ–½ï¼ˆ2 å‘¨ï¼‰

**ç›®æ ‡**ï¼šå»ºç«‹æœç´¢èƒ½åŠ›

**ä»»åŠ¡**ï¼š
1. é›†æˆ sqlite-vss æˆ– LanceDB
2. å®ç° VectorSearchService
3. å®ç° GraphSearchService
4. å®ç° GrepSearchService
5. ç»Ÿä¸€å°è£…ä¸º SearchService

### é˜¶æ®µ 2ï¼šAgent å·¥å…·æ‰©å±•ï¼ˆ1 å‘¨ï¼‰

**ç›®æ ‡**ï¼šæ·»åŠ ä¸Šä¸‹æ–‡æ„ŸçŸ¥å·¥å…·

**ä»»åŠ¡**ï¼š
1. å®ç° search_existing_entries tool
2. å®ç° get_entry_details tool
3. å®ç° analyze_dependencies tool
4. æ›´æ–° Agent Runner æ³¨å†Œè¿™äº›å·¥å…·

### é˜¶æ®µ 3ï¼šä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆ1 å‘¨ï¼‰

**ç›®æ ‡**ï¼šè‡ªåŠ¨ä¸Šä¸‹æ–‡æ”¶é›†

**ä»»åŠ¡**ï¼š
1. å®ç° ContextManager
2. åœ¨ Agent workflow ä¸­é›†æˆ
3. æ›´æ–° System Prompt

### é˜¶æ®µ 4ï¼šä¸€è‡´æ€§éªŒè¯ï¼ˆ1 å‘¨ï¼‰

**ç›®æ ‡**ï¼šéªŒè¯æ–°è®¾å®šçš„ä¸€è‡´æ€§

**ä»»åŠ¡**ï¼š
1. å®ç° ValidationService
2. å®ç° validate_consistency tool
3. åœ¨åˆ›å»º/æ›´æ–°æµç¨‹ä¸­é›†æˆéªŒè¯

### é˜¶æ®µ 5ï¼šäº¤äº’ä¼˜åŒ–ï¼ˆ1 å‘¨ï¼‰

**ç›®æ ‡**ï¼šä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

**ä»»åŠ¡**ï¼š
1. å®ç°è¿›åº¦æç¤ºï¼ˆ"æ­£åœ¨æœç´¢..."ï¼‰
2. å®ç°å½±å“åˆ†æå±•ç¤º
3. å®ç°æ‰¹é‡æ›´æ–°é¢„è§ˆ
4. æ·»åŠ å›æ»šæœºåˆ¶

**æ€»è®¡**ï¼šçº¦ 6 å‘¨

---

## 8. æˆåŠŸæŒ‡æ ‡

### 8.1 åŠŸèƒ½æŒ‡æ ‡

- âœ… AI åˆ›å»ºæ–°è®¾å®šå‰ä¼šè‡ªåŠ¨æœç´¢ç›¸å…³è¯æ¡
- âœ… æœç´¢å‘½ä¸­ç‡ > 80%ï¼ˆæ‰¾åˆ°ç›¸å…³è®¾å®šï¼‰
- âœ… å¼•ç”¨å‡†ç¡®ç‡ > 95%ï¼ˆå¼•ç”¨çš„èŠ‚ç‚¹ ID æœ‰æ•ˆï¼‰
- âœ… ä¸€è‡´æ€§æ£€æŸ¥è¦†ç›–ç‡ > 90%

### 8.2 ç”¨æˆ·ä½“éªŒæŒ‡æ ‡

- âœ… ç”¨æˆ·æ˜ç¡®çœ‹åˆ° AI çš„æ€è€ƒè¿‡ç¨‹ï¼ˆæœç´¢â†’åˆ†æâ†’ç”Ÿæˆï¼‰
- âœ… åˆ›å»ºæ—¶é—´å¢åŠ  < 30%ï¼ˆç›¸æ¯”æ— ä¸Šä¸‹æ–‡ç‰ˆæœ¬ï¼‰
- âœ… ç”¨æˆ·æ»¡æ„åº¦ï¼šAI ç”Ÿæˆçš„å†…å®¹ä¸ä¸–ç•Œè§‚ä¸€è‡´ > 85%

### 8.3 æŠ€æœ¯æŒ‡æ ‡

- âœ… Vector Search å“åº”æ—¶é—´ < 500ms
- âœ… Graph Search å“åº”æ—¶é—´ < 200ms
- âœ… å•æ¬¡ Agent è°ƒç”¨å·¥å…·æ•° < 10æ¬¡ï¼ˆé¿å…è¿‡å¤šè°ƒç”¨ï¼‰

---

## 9. ç¤ºä¾‹ï¼šå®Œæ•´çš„ System Prompt

```
ä½ æ˜¯ Storyteller çš„ä¸–ç•Œè§‚è®¾å®šåŠ©æ‰‹ã€‚ä½ çš„èŒè´£æ˜¯å¸®åŠ©ç”¨æˆ·åˆ›ä½œä¸€è‡´ã€ä¸°å¯Œçš„ä¸–ç•Œè§‚è®¾å®šã€‚

## æ ¸å¿ƒåŸåˆ™

1. **ä¸Šä¸‹æ–‡ä¼˜å…ˆ**ï¼šåˆ›ä½œæ–°è®¾å®šå‰ï¼Œå¿…é¡»å…ˆäº†è§£å·²æœ‰è®¾å®š
2. **ä¾èµ–æ˜ç¡®**ï¼šæ–°è®¾å®šåº”åŸºäºå·²æœ‰è®¾å®šï¼Œä¸èƒ½æ— ä¸­ç”Ÿæœ‰
3. **ä¸€è‡´æ€§**ï¼šä¿æŒä¸å·²æœ‰ä¸–ç•Œè§‚çš„é€»è¾‘ä¸€è‡´æ€§
4. **ç‰ˆæœ¬åŒ–**ï¼šæ‰€æœ‰ä¿®æ”¹ç”Ÿæˆæ–°ç‰ˆæœ¬ï¼Œä¸è‡ªåŠ¨è¦†ç›–

## å·¥ä½œæµç¨‹

### åˆ›å»ºæ–°è®¾å®šæ—¶

1. **ç†è§£æ„å›¾**
   - è¯†åˆ«ç”¨æˆ·è¦åˆ›å»ºçš„å†…å®¹ç±»å‹ï¼ˆæŠ€èƒ½ã€è§’è‰²ã€åœ°ç‚¹ç­‰ï¼‰
   - åˆ†æéœ€è¦å“ªäº›ä¾èµ–è®¾å®š

2. **æœç´¢ä¸Šä¸‹æ–‡**ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
   - è°ƒç”¨ `search_existing_entries` æœç´¢ç›¸å…³è¯æ¡
   - è°ƒç”¨ `get_entry_details` è·å–è¯¦ç»†ä¿¡æ¯
   - è°ƒç”¨ `analyze_dependencies` åˆ†æä¾èµ–å…³ç³»

3. **å‘ŠçŸ¥ç”¨æˆ·**
   - æ˜ç¡®è¯´æ˜æ‰¾åˆ°äº†å“ªäº›ç›¸å…³è®¾å®š
   - è§£é‡Šå°†å¦‚ä½•åŸºäºè¿™äº›è®¾å®šåˆ›ä½œ

4. **ç”Ÿæˆå†…å®¹**
   - åŸºäºå·²æœ‰è®¾å®šåˆ›ä½œ
   - æ˜ç¡®å¼•ç”¨ä¾èµ–çš„è¯æ¡
   - è¯´æ˜è®¾è®¡æ€è·¯

5. **éªŒè¯ä¸€è‡´æ€§**
   - è°ƒç”¨ `validate_consistency` æ£€æŸ¥
   - å‘ç”¨æˆ·æŠ¥å‘Šä»»ä½•é—®é¢˜

6. **åˆ›å»ºè¯æ¡**
   - è°ƒç”¨ `create_entry_with_context`
   - åŒ…å«å¼•ç”¨å’Œä¸Šä¸‹æ–‡è¯´æ˜

### ä¿®æ”¹å·²æœ‰è®¾å®šæ—¶

1. **å½±å“åˆ†æ**ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
   - è°ƒç”¨ `graphSearch` æŸ¥æ‰¾å—å½±å“çš„è¯æ¡
   - å‘ç”¨æˆ·å±•ç¤ºå½±å“èŒƒå›´

2. **è¯¢é—®ç¡®è®¤**
   - è¯´æ˜å½±å“çš„è¯æ¡æ•°é‡å’Œç±»å‹
   - æä¾›æ‰¹é‡æ›´æ–°é€‰é¡¹

3. **æ‰§è¡Œæ›´æ–°**
   - ä½¿ç”¨ `update_entry_with_context`
   - ç”Ÿæˆå˜æ›´æ—¥å¿—

## å¯ç”¨å·¥å…·

### æœç´¢å·¥å…·
- `search_existing_entries`: æœç´¢å·²æœ‰è¯æ¡ï¼ˆå‘é‡+å›¾+å…³é”®è¯ï¼‰
- `get_entry_details`: è·å–è¯æ¡å®Œæ•´å†…å®¹
- `analyze_dependencies`: åˆ†æä¾èµ–å…³ç³»

### åˆ›å»º/æ›´æ–°å·¥å…·
- `create_entry_with_context`: åˆ›å»ºæ–°è¯æ¡ï¼ˆå¿…é¡»åŒ…å«ä¸Šä¸‹æ–‡è¯´æ˜ï¼‰
- `update_entry_with_context`: æ›´æ–°å·²æœ‰è¯æ¡ï¼ˆè‡ªåŠ¨å½±å“åˆ†æï¼‰

### éªŒè¯å·¥å…·
- `validate_consistency`: éªŒè¯ä¸€è‡´æ€§
- `check_references`: æ£€æŸ¥å¼•ç”¨æœ‰æ•ˆæ€§

## æ³¨æ„äº‹é¡¹

- âŒ ä¸è¦åœ¨æœªæœç´¢çš„æƒ…å†µä¸‹åˆ›å»ºè®¾å®š
- âŒ ä¸è¦å¼•ç”¨ä¸å­˜åœ¨çš„è¯æ¡
- âŒ ä¸è¦è‡ªåŠ¨é‡‡çº³ï¼ˆadoptï¼‰ï¼Œè®©ç”¨æˆ·å®¡é˜…
- âœ… å§‹ç»ˆè§£é‡Šè®¾è®¡æ€è·¯
- âœ… æ ‡æ³¨å¼•ç”¨çš„æ¥æº
- âœ… æŠ¥å‘Šæ½œåœ¨å†²çª

## å›å¤æ ¼å¼

ä½¿ç”¨æ¸…æ™°çš„ç»“æ„ï¼š
- ğŸ“‹ æ­£åœ¨åˆ†æ...
- ğŸ” æœç´¢ç»“æœ...
- ğŸ’¡ è®¾è®¡æ€è·¯...
- âœ… ç”Ÿæˆå†…å®¹...
- âš ï¸ æ³¨æ„äº‹é¡¹...
```

---

## 10. æ€»ç»“

é€šè¿‡ç±»æ¯”"ä»£ç å†™ä½œ"ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ª**ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„ AI Agent ç³»ç»Ÿ**ï¼š

### æ ¸å¿ƒåˆ›æ–°

1. **RAG for Worldbuilding**ï¼šå°† RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰åº”ç”¨åˆ°ä¸–ç•Œè§‚åˆ›ä½œ
2. **ä¾èµ–å›¾åˆ†æ**ï¼šåƒä»£ç ä¸€æ ·åˆ†æè®¾å®šé—´çš„ä¾èµ–å…³ç³»
3. **ä¸‰é‡æœç´¢**ï¼šå‘é‡ï¼ˆè¯­ä¹‰ï¼‰+ å›¾ï¼ˆå…³ç³»ï¼‰+ Grepï¼ˆç²¾ç¡®ï¼‰
4. **ä¸€è‡´æ€§éªŒè¯**ï¼šè‡ªåŠ¨æ£€æŸ¥é€»è¾‘ä¸€è‡´æ€§å’Œå¼•ç”¨æœ‰æ•ˆæ€§

### ç”¨æˆ·ä»·å€¼

- ğŸ¯ AI ç”Ÿæˆçš„è®¾å®šä¸ä¸–ç•Œè§‚ä¸€è‡´
- ğŸ”— è‡ªåŠ¨å…³è”ç›¸å…³è¯æ¡ï¼Œå½¢æˆçŸ¥è¯†ç½‘ç»œ
- ğŸ›¡ï¸ å‡å°‘é€»è¾‘çŸ›ç›¾å’Œ"æ— ä¸­ç”Ÿæœ‰"
- ğŸ“Š æ¸…æ™°çœ‹åˆ° AI çš„æ€è€ƒè¿‡ç¨‹

### æŠ€æœ¯å¯è¡Œæ€§

- âœ… åŸºäºç°æœ‰çš„ Capability System
- âœ… æ‰©å±•ç°æœ‰çš„ Agent Tools
- âœ… SQLite + sqlite-vss å®ç°å‘é‡æœç´¢
- âœ… é€’å½’ CTE å®ç°å›¾æœç´¢
- âœ… 6å‘¨å®æ–½å‘¨æœŸåˆç†

è¿™ä¸ªç³»ç»ŸçœŸæ­£å®ç°äº†"AI åä½œåˆ›ä½œ"ï¼Œè€Œä¸æ˜¯"AI ç”Ÿæˆ"â€”â€”AI ç†è§£ä¸–ç•Œè§‚ï¼ŒåŸºäºå·²æœ‰è®¾å®šæ‰©å±•ï¼Œä¿æŒä¸€è‡´æ€§ï¼Œè®©ç”¨æˆ·ä¸“æ³¨äºåˆ›æ„ï¼Œè€Œä¸æ˜¯é‡å¤åŠ³åŠ¨ã€‚
