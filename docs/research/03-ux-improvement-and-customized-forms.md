# 用户体验改进与定制化表单设计

## 1. 当前问题诊断

### 1.1 问题 1：表单填写感 vs 创作与阅读感

**当前状态**：
- 界面呈现为传统的后台管理表单
- 所有字段平铺展示，无论是否有值
- 编辑模式和阅读模式混杂

**用户反馈**：
- "感觉像在填问卷，而不是在创作"
- "信息密度太高，找不到重点"
- "想快速浏览角色设定，但被一堆空字段干扰"

### 1.2 问题 2：交互不友好

**当前状态**：
- 字段提示（prompt）仅作为 placeholder，不够明显
- 没有空态引导，空字段显示为空白
- 缺少内联编辑，必须进入"编辑模式"
- 版本切换和采纳操作藏在下拉菜单里

**用户反馈**：
- "不知道这个字段应该填什么"
- "每次编辑都要点'保存'，打断思路"
- "想对比两个版本很麻烦"

### 1.3 问题 3：缺少视觉层次

**当前状态**：
- 所有字段等权重展示
- 没有分组折叠
- 关键信息和次要信息混在一起

**用户反馈**：
- "角色的关键信息应该一眼能看到"
- "背景故事很长，应该可以折叠起来"

---

## 2. 设计原则

### 2.1 原则 1：阅读优先，编辑按需

**设计思路**：
- 默认显示为"条目页"或"百科页"，强调内容的可读性
- 内联编辑：点击即可编辑，失焦自动保存（或显式保存）
- 空字段不显示为空行，而是显示引导卡片

### 2.2 原则 2：信息分层

**设计思路**：
- 关键信息置顶或放在侧边栏（Quick Facts）
- 详细内容分组折叠（Appearance, Personality, Background）
- 次要信息默认折叠

### 2.3 原则 3：引导与提示

**设计思路**：
- 空字段显示"AI 可以帮你填写"
- 字段旁显示 prompt 作为创作引导
- 提供快捷操作（如"✨ AI 填充"、"🔄 生成新版本"）

### 2.4 原则 4：版本化透明

**设计思路**：
- 版本历史可见且易访问
- Diff 视图直观对比差异
- 一键切换和采纳

---

## 3. UI 设计方案

### 3.1 布局模式：卡片式 vs 表单式

**方案 A：卡片式（推荐用于阅读）**

```
┌─────────────────────────────────────────┐
│  ┌─────────────┐                        │
│  │   头像      │  姓名：艾莉亚           │
│  │  (Image)    │  年龄：24              │
│  └─────────────┘  性别：女              │
│                   角色：主角             │
│                   所属势力：[流浪者联盟]│
├─────────────────────────────────────────┤
│  📝 外观                         [展开] │
│  身高：165cm                            │
│  发型：黑色长发，通常扎成马尾            │
│  服饰：深色斗篷，便于隐藏武器            │
├─────────────────────────────────────────┤
│  🎭 性格                         [折叠]│
├─────────────────────────────────────────┤
│  📖 人物小传                            │
│  艾莉亚出生于北方...                    │
└─────────────────────────────────────────┘
```

**特点**：
- 信息组织清晰，易于阅读
- 支持折叠/展开，减少信息过载
- 关键信息（头像、姓名、角色定位）置顶

**方案 B：表单式（推荐用于编辑）**

```
┌─────────────────────────────────────────┐
│  基础信息                               │
│  ┌─────────────────────────────────────┐│
│  │ 姓名 *   [艾莉亚            ]      ││
│  │ 年龄     [24                ]      ││
│  │ 性别     [女 ▼]                    ││
│  │ 角色定位 [主角 ▼]                  ││
│  └─────────────────────────────────────┘│
│                                         │
│  外观                            [展开] │
│  ...                                    │
└─────────────────────────────────────────┘
```

**特点**：
- 适合批量输入
- 字段对齐，视觉整洁
- 支持必填标记（*）和验证提示

**推荐策略**：双模式切换
- 默认：卡片式（阅读模式）
- 右上角提供"编辑模式"切换按钮，进入表单式

### 3.2 字段渲染策略

#### 3.2.1 已填充字段：内联编辑

**阅读模式**：
```
性格：勇敢、冲动、固执
      ↑ hover 显示编辑图标
```

**编辑模式**：
```
性格：[勇敢][冲动][固执]  [+ 添加标签]
      ↑ 可点击删除的标签
```

#### 3.2.2 空字段：引导卡片

**不好的做法（当前）**：
```
性格：[                              ]
      ↑ 空白，不知道填什么
```

**改进方案**：
```
┌─────────────────────────────────────┐
│  性格 (未填写)                      │
│  💡 提示：用 3-5 个关键词描述性格   │
│  [手动填写]  [✨ AI 填充]          │
└─────────────────────────────────────┘
```

#### 3.2.3 长文本字段：Markdown 渲染

**阅读模式**：
```
┌─────────────────────────────────────┐
│  人物小传                           │
│                                     │
│  艾莉亚出生于北方的一个小村庄...    │
│  她从小就展现出...                  │
│                                     │
│  [编辑]  [✨ AI 续写]  [🔄 重新生成]│
└─────────────────────────────────────┘
```

**编辑模式**：
- 富文本编辑器（WYSIWYG）
- 或 Markdown 编辑器（带预览）

### 3.3 侧边栏：快速参考区

**设计目标**：一眼看到角色的核心信息

```
┌──────────────────┐
│   [头像/立绘]    │
│                  │
├──────────────────┤
│ 艾莉亚            │
│ 24 岁 / 女        │
│ 主角              │
├──────────────────┤
│ 势力              │
│ 流浪者联盟 →      │
│                  │
│ 出生地            │
│ 北方村庄 →        │
│                  │
│ 关系              │
│ • 雷恩（导师）→   │
│ • 卡莉娅（挚友）→ │
├──────────────────┤
│ [快速操作]       │
│ • AI 完善设定     │
│ • 生成立绘        │
│ • 导出 Markdown   │
└──────────────────┘
```

**特点**：
- 固定在右侧或左侧
- 显示关键字段
- 支持点击跳转（reference 字段）
- 提供快捷操作入口

### 3.4 分组与折叠

**实现方案**：使用 `<details>` 元素或自定义折叠组件

```vue
<template>
  <div class="field-group">
    <div class="group-header" @click="toggleCollapse">
      <span class="icon">{{ collapsed ? '▶' : '▼' }}</span>
      <span class="label">{{ group.label }}</span>
      <span class="count">{{ filledCount }}/{{ totalCount }}</span>
    </div>
    <div v-show="!collapsed" class="group-body">
      <!-- 字段内容 -->
    </div>
  </div>
</template>
```

**UX 细节**：
- 显示"已填写字段数 / 总字段数"（如 3/5）
- 空分组默认折叠
- 已填写分组默认展开

---

## 4. 定制化表单：每个叶子节点的专属体验

### 4.1 需求分析

不同类型的节点需要不同的表单体验：
- **角色卡**：强调头像、性格、关系
- **地理位置**：强调地图、气候、资源
- **魔法体系**：强调规则、限制、施法方式
- **历史事件**：强调时间轴、参与者、影响

### 4.2 实现策略：模板驱动的 UI 变体

**核心思想**：模板不仅定义字段，还定义 UI 风格

```typescript
export type NodeTemplate = {
  id: string
  label: string
  match: (nodeType: string) => boolean
  requiredCapabilities?: string[]
  sections: TemplateSection[]
  
  // 新增：UI 风格配置
  uiStyle?: {
    layout: 'sidebar-right' | 'sidebar-left' | 'fullwidth'
    readingMode: 'card' | 'article' | 'table'
    editingMode: 'inline' | 'modal' | 'form'
    colorScheme?: string  // 配色方案
    icon?: string         // 节点图标
  }
}
```

**示例：角色卡 vs 地理位置**

```typescript
// 角色卡：侧边栏 + 卡片式
{
  id: 'char.card',
  uiStyle: {
    layout: 'sidebar-right',
    readingMode: 'card',
    editingMode: 'inline'
  }
}

// 地理位置：全宽 + 文章式
{
  id: 'world.geo.location',
  uiStyle: {
    layout: 'fullwidth',
    readingMode: 'article',
    editingMode: 'inline'
  }
}
```

### 4.3 自定义 Section 渲染

**扩展 Section 类型**：

```typescript
export type TemplateSection =
  | SectionChildrenList
  | SectionKvGroup
  | SectionMemoBlock
  | SectionCapabilityPanel
  | SectionCustomWidget  // 新增：自定义小部件

export type SectionCustomWidget = {
  type: 'customWidget'
  widgetType: 'timeline' | 'map' | 'graph' | 'gallery' | 'markdown'
  title: string
  dataSource: {
    capabilityId: string
    transform?: string  // 数据转换逻辑（可选）
  }
  uiConfig?: any
}
```

**示例：时间轴小部件**

```typescript
{
  type: 'customWidget',
  widgetType: 'timeline',
  title: '历史事件',
  dataSource: {
    capabilityId: 'kv',
    transform: 'extractTimelineFromKV'  // 从 KV 提取时间轴数据
  }
}
```

### 4.4 字段级 UI 定制

**扩展 `uiConfig`**：

```typescript
export type TemplateField = {
  key: string
  label: string
  valueType: FieldValueType
  uiConfig?: {
    placeholder?: string
    helpText?: string
    prompt?: string
    
    // 新增：UI 渲染选项
    renderAs?: 'inline' | 'card' | 'banner'  // 渲染样式
    icon?: string                             // 字段图标
    color?: string                            // 强调色
    size?: 'small' | 'medium' | 'large'       // 字段大小
    
    // 新增：交互选项
    autoSave?: boolean                        // 自动保存（失焦时）
    aiAssist?: boolean                        // 显示 AI 辅助按钮
    allowEmpty?: boolean                      // 允许留空（不显示引导）
    
    // 类型特定选项
    options?: string[]             // select/multiSelect
    min?: number                   // number/rating
    max?: number                   // number/rating
    nodeTypeFilter?: string[]      // reference/references
  }
}
```

**示例：强调字段（Banner 样式）**

```typescript
{
  key: 'catchphrase',
  label: '经典台词',
  valueType: 'text',
  uiConfig: {
    renderAs: 'banner',  // 以横幅样式显示
    icon: '💬',
    color: '#4A90E2',
    size: 'large',
    prompt: '这个角色最具代表性的一句话'
  }
}
```

**渲染效果**：
```
┌─────────────────────────────────────────┐
│  💬 经典台词                            │
│  "我从不回头看爆炸"                     │
└─────────────────────────────────────────┘
     ↑ 大字体、强调色背景
```

---

## 5. 交互增强

### 5.1 AI 辅助按钮

**位置**：每个字段的右侧或下方

**功能**：
- ✨ AI 填充：根据上下文生成内容
- 🔄 重新生成：生成新版本
- 📝 AI 续写：在现有内容基础上续写（长文本字段）
- 🎨 AI 润色：改进措辞和表达（长文本字段）

**实现**：

```vue
<div class="field-actions">
  <button @click="aiFill" title="AI 填充">✨</button>
  <button @click="aiRegenerate" title="重新生成">🔄</button>
  <button v-if="isLongText" @click="aiContinue" title="续写">📝</button>
</div>
```

### 5.2 版本对比 Diff 视图

**触发**：在版本选择器中点击"对比"按钮

**UI 设计**：

```
┌─────────────────────────────────────────┐
│  版本对比                               │
│  左侧：v2 (当前采纳)                    │
│  右侧：v3 (待审阅)                      │
├─────────────────────────────────────────┤
│  姓名                                   │
│  艾莉亚        |  艾莉亚                │
│  ─────────────────────────────────────  │
│  性格                                   │
│  勇敢、冲动    |  勇敢、冲动、固执      │
│           新增 ───────────────→         │
│  ─────────────────────────────────────  │
│  背景故事                               │
│  出生于...     |  出生于...她从小...    │
│           扩写 ───────────────→         │
├─────────────────────────────────────────┤
│  [← 采纳 v2]  [采纳 v3 →]              │
└─────────────────────────────────────────┘
```

**功能**：
- 高亮新增、删除、修改的字段
- 支持逐字段对比（长文本显示 word-level diff）
- 一键采纳某个版本

### 5.3 快捷操作面板

**位置**：节点页面顶部或侧边栏底部

**内容**：
```
┌──────────────────────────────────────┐
│  快捷操作                            │
│  • 🤖 AI 完善设定                    │
│  • 🎨 生成立绘                       │
│  • 📋 复制设定到剪贴板                │
│  • 📤 导出 Markdown                  │
│  • 🔗 创建关联角色                    │
└──────────────────────────────────────┘
```

### 5.4 拖拽排序与重组

**场景**：用户希望调整字段顺序或分组

**实现**：
- 在编辑模式下，字段显示拖拽手柄
- 拖拽字段到不同分组
- 拖拽分组调整顺序
- 保存为 Instance Override（不影响模板）

---

## 6. 响应式与适配

### 6.1 不同屏幕尺寸

- **大屏（> 1440px）**：侧边栏 + 主内容区
- **中屏（1024-1440px）**：侧边栏可折叠
- **小屏（< 1024px）**：侧边栏转为顶部卡片，主内容区占满宽度

### 6.2 暗色模式

- 支持系统级暗色模式切换
- 字段卡片使用暗色背景
- 强调色调整为暗色模式友好的色调

---

## 7. 无障碍访问（Accessibility）

### 7.1 键盘导航

- Tab 键在字段间跳转
- Enter 键进入编辑模式
- Esc 键退出编辑模式
- Ctrl+S 保存

### 7.2 语义化标签

- 使用 `<label>` 关联 `<input>`
- 使用 ARIA 属性标注交互元素
- 为图标按钮提供 `aria-label`

### 7.3 对比度与字体大小

- 遵循 WCAG 2.1 AA 标准
- 支持用户自定义字体大小
- 强调色与背景色对比度 > 4.5:1

---

## 8. 实施路线

### 第一阶段：基础 UI 改进（1 周）

**目标**：从表单式改为卡片式

**任务**：
1. 实现阅读模式和编辑模式切换
2. 实现字段分组与折叠
3. 优化侧边栏布局
4. 空字段显示引导卡片

### 第二阶段：内联编辑与 AI 辅助（1 周）

**目标**：提升编辑体验

**任务**：
1. 实现字段的内联编辑
2. 添加 AI 辅助按钮
3. 实现自动保存机制
4. 添加加载状态和错误提示

### 第三阶段：版本对比与高级交互（1 周）

**目标**：完善版本化工作流

**任务**：
1. 实现 Diff 视图
2. 优化版本切换 UI
3. 添加快捷操作面板
4. 实现拖拽排序

### 第四阶段：定制化 Section 渲染（1 周）

**目标**：支持不同节点类型的专属 UI

**任务**：
1. 实现 `uiStyle` 配置
2. 实现自定义 Widget（Timeline, Map）
3. 实现字段级 UI 定制（renderAs, icon, color）
4. 更新所有模板使用新的 UI 配置

---

## 9. 设计规范（Design System）

### 9.1 色彩系统

```
主色（Primary）：#4A90E2
辅色（Secondary）：#50C878
强调色（Accent）：#F39C12
警告色（Warning）：#E74C3C
成功色（Success）：#2ECC71
文本色（Text）：#333333
次要文本（Secondary Text）：#777777
边框色（Border）：rgba(0, 0, 0, 0.08)
背景色（Background）：#FFFFFF
卡片背景（Card Background）：#F9F9F9
```

### 9.2 间距系统

```
xs: 4px
sm: 8px
md: 12px
lg: 16px
xl: 24px
xxl: 32px
```

### 9.3 圆角

```
字段输入框：10px
卡片：12px
按钮：8px
```

### 9.4 阴影

```
浮起（Hover）：0 2px 8px rgba(0, 0, 0, 0.08)
卡片：0 1px 4px rgba(0, 0, 0, 0.06)
模态框：0 8px 24px rgba(0, 0, 0, 0.12)
```

---

## 10. 总结

通过以上改进，我们实现：

1. **从表单到条目页**：默认阅读模式，点击即编辑
2. **信息分层**：关键信息置顶，详细内容分组折叠
3. **AI 辅助无处不在**：每个字段都有 AI 填充按钮
4. **版本化透明**：Diff 视图直观对比，一键采纳
5. **定制化体验**：每个节点类型有专属 UI 风格

**最终效果**：
- 用户感觉在"创作和阅读"，而不是"填表单"
- 关键信息一目了然，次要信息有序组织
- AI 成为无缝的创作助手，而不是独立的工具
- 版本管理自然融入工作流，不再是负担

**下一步行动**：
- 按照实施路线分阶段开发
- 制作 UI 原型并邀请用户测试
- 收集反馈并持续迭代
