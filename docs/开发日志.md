# 开发日志

日期：2025-12-13

## 本次目标
根据一期 PRD 的 UI 设想先落地一个“可跑的 UI 骨架”，验证三件事：
1) 左侧 Chat UI（尽量用现成组件）
2) 右侧多步骤 DAG 展示（Vue Flow）
3) 节点支持“AI 注入 HTML/CSS/JS 并执行”的沙箱渲染（iframe sandbox + CSP）

## 本次完成内容
### 1) Electron + Vite + Vue 渲染进程
- 将渲染层切换为 Vite 驱动：开发时由 Vite dev server 提供页面，生产构建输出到 `renderer/dist/`。
- Electron 主进程在开发模式读取 `VITE_DEV_SERVER_URL`，否则读取 `renderer/dist/index.html`。

相关文件：
- main 进程入口：[main.js](main.js)
- Vite 配置：[renderer/vite.config.ts](renderer/vite.config.ts)
- Vue 入口：[renderer/src/main.ts](renderer/src/main.ts)

### 2) UI 三栏布局（一期方向）
- 左侧：Chat
- 右侧上：DAG（Steps）
- 右侧下：Node Inspector（节点详情 + 沙箱编辑器 + 预览）

相关文件：
- 布局：[renderer/src/App.vue](renderer/src/App.vue)
- DAG：[renderer/src/components/DagPane.vue](renderer/src/components/DagPane.vue)
- 节点详情：[renderer/src/components/NodeInspector.vue](renderer/src/components/NodeInspector.vue)

### 3) Chat 组件：vue-advanced-chat
- 集成 `vue-advanced-chat`（web component）。
- 当前实现为“本地 mock 消息 + 模拟流式输出”（逐字更新同一条 assistant 消息）。
- 关键点：为了避免 custom element 属性/类型差异导致一直 loading，本次通过 `ref` 直接给 DOM property 赋值（rooms/messages/messagesLoaded/roomsLoaded），确保组件稳定渲染。
- 输入区改为自定义：支持多行（Enter 换行，Cmd+Enter 发送），并移除表情/语音/附件等不需要的入口；工具栏放在输入框上方。

### 6) Agent（LangChain）与设置页（SQLite 持久化）
- Agent 迁移到 Electron 主进程运行：renderer 通过 IPC 启动一次对话流，按 token delta 回传并追加到同一条 assistant 消息。
- 新增“设置”页：配置 `endpoint/model/apiKey`，保存到本机 SQLite（`<userData>/storyteller.db`）。
- 使用 `better-sqlite3` 需要 `electron-rebuild`：已在 `postinstall` 自动执行。

相关文件：
- Chat 面板：[renderer/src/components/ChatPane.vue](renderer/src/components/ChatPane.vue)
- Chat store（含模拟流式）：[renderer/src/stores/chat.ts](renderer/src/stores/chat.ts)

### 4) DAG：Vue Flow
- 选型：`@vue-flow/core`。
- 当前为固定步骤链示例数据（后续会接入真实的 Steps/Artifacts/Versions）。

备注：`@vue-flow/background` 的样式文件在该版本未通过 package exports 暴露，Vite 会拒绝深导入 `dist/style.css`。本次先移除背景样式导入，不影响功能。

相关文件：
- Pipeline store：[renderer/src/stores/pipeline.ts](renderer/src/stores/pipeline.ts)
- 节点渲染组件：[renderer/src/components/StepNode.vue](renderer/src/components/StepNode.vue)

### 5) 节点沙箱渲染（AI 注入并执行）
- 每个节点可以携带 `sandbox: { html, css, js }`。
- 通过 `iframe sandbox="allow-scripts"` + `srcdoc` 渲染。
- 默认 CSP：禁止网络请求（`connect-src 'none'`），仅允许 `data:`/`blob:` 图片。
- 预留 `postMessage` bridge：`window.storyteller.log()` / `window.storyteller.request()`（后续可做白名单 API）。

相关文件：
- 沙箱组件：[renderer/src/components/SandboxFrame.vue](renderer/src/components/SandboxFrame.vue)

## 运行方式
- 开发：`yarn dev`
  - 自动启动 Vite（127.0.0.1:5173）并启动 Electron。
- 类型检查：`yarn typecheck`
- 生产构建渲染：`yarn build:renderer`
  - 然后可用 `yarn start` 打开 Electron（读取 `renderer/dist/index.html`）。

## 手工验证点
- 左侧 Chat：输入任意内容，看到 AI 逐字“流式”回复。
- 输入包含“注入/Inject/Sandbox”的消息：右侧分镜节点会被注入一段可点击的脚本 UI。
- 右侧 Node Inspector：可编辑 HTML/CSS/JS 并点击“应用到节点”，预览应立即刷新。

## 风险与后续
- 当前沙箱只做最小隔离：
  - 已禁网络，但仍允许执行任意 JS；后续需要增加“信任确认/签名/来源标记/停止执行”等。
- 当前流式为 mock：
  - 已预留并实现“主进程代理 + IPC delta”形态（见 ADR 0002），可配置 OpenAI-compatible 接口输出真实流式。
- DAG 目前是固定布局：
  - 后续改为根据 Step/依赖动态布局，并展示版本数/产物摘要。
